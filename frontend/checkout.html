<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡®è®¤è®¢å• - Shop</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/order.css">
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸ›’ Shop</a>
        <div class="nav-links" id="navLinks"></div>
    </nav>

    <div class="page-container checkout-page">
        <div class="breadcrumb">
            <a href="index.html">é¦–é¡µ</a> &gt;
            <a href="cart.html">è´­ç‰©è½¦</a> &gt;
            <span>ç¡®è®¤è®¢å•</span>
        </div>

        <div id="checkoutContent">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/order-api.js"></script>
    <script src="js/product-api.js"></script>
    <script>
        let selectedAddressId = 0;
        let cartData = null;
        let directBuyData = null;

        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireLogin()) return;
            updateNavbar();

            // åˆ¤æ–­æ˜¯è´­ç‰©è½¦ç»“ç®—è¿˜æ˜¯ç›´æ¥è´­ä¹°
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'direct') {
                const productId = parseInt(urlParams.get('product_id'));
                const quantity = parseInt(urlParams.get('quantity')) || 1;
                const skuId = parseInt(urlParams.get('sku_id')) || 0;
                if (productId > 0) {
                    loadDirectBuyData(productId, quantity, skuId);
                } else {
                    loadCheckoutData();
                }
            } else {
                loadCheckoutData();
            }
        });

        function updateNavbar() {
            const navLinks = document.getElementById('navLinks');
            const user = Auth.getUser();
            navLinks.innerHTML = `
                <a href="products.html">å•†å“</a>
                <a href="cart.html">ğŸ›’ è´­ç‰©è½¦</a>
                <a href="orders.html">ğŸ“¦ è®¢å•</a>
                <a href="favorites.html">â¤ï¸ æ”¶è—</a>
                <a href="footprints.html">ğŸ‘£ è¶³è¿¹</a>
                <a href="profile.html">ğŸ‘¤ ${user ? user.username : ''}</a>
                <a href="#" onclick="handleLogout()">é€€å‡º</a>
            `;
        }

        async function loadCheckoutData() {
            const container = document.getElementById('checkoutContent');

            // å¹¶è¡ŒåŠ è½½è´­ç‰©è½¦å’Œåœ°å€
            const [cartResult, addrResult] = await Promise.all([
                OrderAPI.getCartList(),
                OrderAPI.getAddressList()
            ]);

            if (!cartResult.success || cartResult.data.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ›’</div>
                        <p>è´­ç‰©è½¦ä¸ºç©ºï¼Œæ— æ³•ç»“ç®—</p>
                        <a href="products.html" class="btn btn-primary">å»é€›é€›</a>
                    </div>`;
                return;
            }

            cartData = cartResult.data;
            const addresses = addrResult.success ? addrResult.data : [];

            // é€‰æ‹©é»˜è®¤åœ°å€
            const defaultAddr = addresses.find(a => a.is_default);
            if (defaultAddr) selectedAddressId = defaultAddr.id;
            else if (addresses.length > 0) selectedAddressId = addresses[0].id;

            container.innerHTML = `
                <!-- æ”¶è´§åœ°å€ -->
                <div class="checkout-section">
                    <div class="checkout-section-header">
                        <h3>ğŸ“ æ”¶è´§åœ°å€</h3>
                        <a href="addresses.html" style="color:#007bff;text-decoration:none;font-size:13px;">ç®¡ç†åœ°å€</a>
                    </div>
                    <div class="checkout-section-body">
                        ${addresses.length > 0 ? `
                            <div class="address-select-list">
                                ${addresses.map(addr => `
                                    <div class="address-select-item ${addr.id === selectedAddressId ? 'selected' : ''}" 
                                         onclick="selectAddress(${addr.id})">
                                        <input type="radio" name="address" value="${addr.id}" 
                                               ${addr.id === selectedAddressId ? 'checked' : ''} />
                                        <div class="address-select-info">
                                            <div class="name-phone">
                                                ${escapeHtml(addr.name)} ${addr.phone}
                                                ${addr.is_default ? '<span style="color:#007bff;font-size:12px;margin-left:8px;">[é»˜è®¤]</span>' : ''}
                                            </div>
                                            <div class="addr-text">${escapeHtml(addr.full_address)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align:center;padding:20px;color:#999;">
                                <p>æš‚æ— æ”¶è´§åœ°å€</p>
                                <a href="addresses.html" class="btn btn-primary" style="width:auto;display:inline-block;padding:8px 20px;margin-top:10px;">æ·»åŠ åœ°å€</a>
                            </div>
                        `}
                    </div>
                </div>

                <!-- å•†å“åˆ—è¡¨ -->
                <div class="checkout-section">
                    <div class="checkout-section-header">
                        <h3>ğŸ›ï¸ å•†å“æ¸…å•</h3>
                    </div>
                    <div class="checkout-section-body">
                        ${cartData.items.filter(i => i.is_valid).map(item => `
                            <div class="checkout-item">
                                <div class="checkout-item-img">
                                    ${item.cover_image ? `<img src="${item.cover_image}" />` : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:12px;">æ— å›¾</div>'}
                                </div>
                                <div class="checkout-item-name">${escapeHtml(item.name)}</div>
                                <div class="checkout-item-price">Â¥${item.price.toFixed(2)}</div>
                                <div class="checkout-item-qty">Ã—${item.quantity}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- å¤‡æ³¨ -->
                <div class="checkout-section">
                    <div class="checkout-section-body">
                        <div class="form-group" style="margin:0;">
                            <label>è®¢å•å¤‡æ³¨</label>
                            <input type="text" id="orderRemark" placeholder="é€‰å¡«ï¼Œå¯å¡«å†™ç‰¹æ®Šéœ€æ±‚" 
                                   style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:4px;font-size:14px;" />
                        </div>
                    </div>
                </div>

                <!-- ç»“ç®—æ  -->
                <div class="checkout-bar">
                    <div class="checkout-total">
                        å…± <strong>${cartData.total_quantity}</strong> ä»¶å•†å“ï¼Œåˆè®¡ï¼š
                        <span class="total-price">Â¥${cartData.total_amount.toFixed(2)}</span>
                    </div>
                    <button class="btn-submit-order" onclick="submitOrder()" ${addresses.length === 0 ? 'disabled' : ''}>
                        æäº¤è®¢å•
                    </button>
                </div>
            `;
        }

        function selectAddress(id) {
            selectedAddressId = id;
            document.querySelectorAll('.address-select-item').forEach(el => {
                el.classList.remove('selected');
                el.querySelector('input[type="radio"]').checked = false;
            });
            const item = document.querySelector(`.address-select-item input[value="${id}"]`);
            if (item) {
                item.checked = true;
                item.closest('.address-select-item').classList.add('selected');
            }
        }

        // ç«‹å³è´­ä¹°æ¨¡å¼ï¼šåŠ è½½å•†å“ä¿¡æ¯å¹¶æ¸²æŸ“
        async function loadDirectBuyData(productId, quantity, skuId) {
            const container = document.getElementById('checkoutContent');

            const [productResult, addrResult] = await Promise.all([
                ProductAPI.getProductDetail(productId),
                OrderAPI.getAddressList()
            ]);

            if (!productResult.success) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âŒ</div>
                        <p>å•†å“ä¿¡æ¯åŠ è½½å¤±è´¥</p>
                        <a href="products.html" class="btn btn-primary">å»é€›é€›</a>
                    </div>`;
                return;
            }

            const product = productResult.data;
            const addresses = addrResult.success ? addrResult.data : [];

            let itemPrice = parseFloat(product.price);
            let coverImage = product.cover_image;
            let skuName = '';

            if (skuId > 0 && product.skus) {
                const sku = product.skus.find(s => s.id === skuId);
                if (sku) {
                    itemPrice = parseFloat(sku.price);
                    if (sku.cover_image) coverImage = sku.cover_image;
                    if (sku.attr_text) {
                        skuName = sku.attr_text.replace(/;/g, ' | ');
                    } else if (sku.attributes) {
                        skuName = sku.attributes.map(a => a.attr_name + ':' + a.value).join(' | ');
                    }
                }
            }

            const totalAmount = (itemPrice * quantity).toFixed(2);
            directBuyData = { productId, skuId: skuId || null, quantity, itemPrice, totalAmount };

            const defaultAddr = addresses.find(a => a.is_default);
            if (defaultAddr) selectedAddressId = defaultAddr.id;
            else if (addresses.length > 0) selectedAddressId = addresses[0].id;

            container.innerHTML = `
                <div class="checkout-section">
                    <div class="checkout-section-header">
                        <h3>ğŸ“ æ”¶è´§åœ°å€</h3>
                        <a href="addresses.html" style="color:#007bff;text-decoration:none;font-size:13px;">ç®¡ç†åœ°å€</a>
                    </div>
                    <div class="checkout-section-body">
                        ${addresses.length > 0 ? `
                            <div class="address-select-list">
                                ${addresses.map(addr => `
                                    <div class="address-select-item ${addr.id === selectedAddressId ? 'selected' : ''}" 
                                         onclick="selectAddress(${addr.id})">
                                        <input type="radio" name="address" value="${addr.id}" 
                                               ${addr.id === selectedAddressId ? 'checked' : ''} />
                                        <div class="address-select-info">
                                            <div class="name-phone">
                                                ${escapeHtml(addr.name)} ${addr.phone}
                                                ${addr.is_default ? '<span style="color:#007bff;font-size:12px;margin-left:8px;">[é»˜è®¤]</span>' : ''}
                                            </div>
                                            <div class="addr-text">${escapeHtml(addr.full_address)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align:center;padding:20px;color:#999;">
                                <p>æš‚æ— æ”¶è´§åœ°å€</p>
                                <a href="addresses.html" class="btn btn-primary" style="width:auto;display:inline-block;padding:8px 20px;margin-top:10px;">æ·»åŠ åœ°å€</a>
                            </div>
                        `}
                    </div>
                </div>

                <div class="checkout-section">
                    <div class="checkout-section-header">
                        <h3>ğŸ›ï¸ å•†å“æ¸…å•</h3>
                    </div>
                    <div class="checkout-section-body">
                        <div class="checkout-item">
                            <div class="checkout-item-img">
                                ${coverImage ? `<img src="${coverImage}" />` : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:12px;">æ— å›¾</div>'}
                            </div>
                            <div class="checkout-item-name">
                                ${escapeHtml(product.name)}
                                ${skuName ? `<div style="color:#999;font-size:12px;margin-top:4px;">${escapeHtml(skuName)}</div>` : ''}
                            </div>
                            <div class="checkout-item-price">Â¥${itemPrice.toFixed(2)}</div>
                            <div class="checkout-item-qty">Ã—${quantity}</div>
                        </div>
                    </div>
                </div>

                <div class="checkout-section">
                    <div class="checkout-section-body">
                        <div class="form-group" style="margin:0;">
                            <label>è®¢å•å¤‡æ³¨</label>
                            <input type="text" id="orderRemark" placeholder="é€‰å¡«ï¼Œå¯å¡«å†™ç‰¹æ®Šéœ€æ±‚" 
                                   style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:4px;font-size:14px;" />
                        </div>
                    </div>
                </div>

                <div class="checkout-bar">
                    <div class="checkout-total">
                        å…± <strong>${quantity}</strong> ä»¶å•†å“ï¼Œåˆè®¡ï¼š
                        <span class="total-price">Â¥${totalAmount}</span>
                    </div>
                    <button class="btn-submit-order" onclick="submitOrder()" ${addresses.length === 0 ? 'disabled' : ''}>
                        æäº¤è®¢å•
                    </button>
                </div>
            `;
        }

        async function submitOrder() {
            if (!selectedAddressId) {
                alert('è¯·é€‰æ‹©æ”¶è´§åœ°å€');
                return;
            }

            const remark = document.getElementById('orderRemark')?.value || '';

            if (!confirm('ç¡®è®¤æäº¤è®¢å•ï¼Ÿ')) return;

            let result;
            if (directBuyData) {
                result = await OrderAPI.directBuy(
                    directBuyData.productId,
                    directBuyData.quantity,
                    directBuyData.skuId,
                    selectedAddressId,
                    remark
                );
            } else {
                result = await OrderAPI.createOrder(selectedAddressId, null, remark);
            }

            if (result.success) {
                alert('è®¢å•åˆ›å»ºæˆåŠŸï¼');
                window.location.href = `order-detail.html?id=${result.data.order_id}`;
            } else {
                alert(result.message);
            }
        }

        async function handleLogout() {
            await API.logout();
            Auth.clearUser();
            window.location.href = 'index.html';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
