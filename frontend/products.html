<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“åˆ—è¡¨ - Shop</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/product.css">
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸ›’ Shop</a>
        <div class="nav-links" id="navLinks">
            <!-- JS åŠ¨æ€å¡«å…… -->
        </div>
    </nav>

    <div class="page-container">
        <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
        <div class="filter-section">
            <div class="search-box">
                <input type="text" id="searchKeyword" placeholder="æœç´¢å•†å“åç§°..." />
                <button class="btn btn-primary btn-search" onclick="handleSearch()">æœç´¢</button>
            </div>
            <div class="filter-row">
                <div class="filter-item">
                    <label>åˆ†ç±»ï¼š</label>
                    <select id="filterCategory">
                        <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>ä»·æ ¼ï¼š</label>
                    <input type="number" id="minPrice" placeholder="æœ€ä½" class="price-input" />
                    <span>-</span>
                    <input type="number" id="maxPrice" placeholder="æœ€é«˜" class="price-input" />
                </div>
                <div class="filter-item">
                    <label>åº“å­˜ï¼š</label>
                    <select id="filterStock">
                        <option value="">å…¨éƒ¨</option>
                        <option value="1">æœ‰è´§</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>æ’åºï¼š</label>
                    <select id="sortBy">
                        <option value="id">é»˜è®¤</option>
                        <option value="price">ä»·æ ¼</option>
                        <option value="created_at">ä¸Šæ¶æ—¶é—´</option>
                    </select>
                    <select id="sortOrder">
                        <option value="DESC">é™åº</option>
                        <option value="ASC">å‡åº</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- å•†å“åˆ—è¡¨ -->
        <div class="product-grid" id="productGrid">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <!-- åˆ†é¡µ -->
        <div class="pagination" id="pagination"></div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/product-api.js"></script>
    <script>
        // å½“å‰é¡µç 
        let currentPage = 1;
        const pageSize = 12;

        document.addEventListener('DOMContentLoaded', function() {
            updateNavbar();
            loadCategories();
            loadProducts();

            // å›è½¦æœç´¢
            document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleSearch();
            });

            // ç­›é€‰æ¡ä»¶æ”¹å˜æ—¶è‡ªåŠ¨æœç´¢
            ['filterCategory', 'filterStock', 'sortBy', 'sortOrder'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    currentPage = 1;
                    loadProducts();
                });
            });
        });

        // æ›´æ–°å¯¼èˆªæ 
        function updateNavbar() {
            const navLinks = document.getElementById('navLinks');
            let html = '<a href="products.html" class="active">å•†å“</a>';
            
            if (Auth.isLoggedIn()) {
                const user = Auth.getUser();
                html += `
                    <a href="cart.html">ğŸ›’ è´­ç‰©è½¦</a>
                    <a href="orders.html">ğŸ“¦ è®¢å•</a>
                    <a href="favorites.html">â¤ï¸ æ”¶è—</a>
                    <a href="footprints.html">ğŸ‘£ è¶³è¿¹</a>
                    <a href="profile.html">ğŸ‘¤ ${user.username}</a>
                    <a href="#" onclick="handleLogout()">é€€å‡º</a>
                `;
            } else {
                html += `
                    <a href="login.html">ç™»å½•</a>
                    <a href="register.html">æ³¨å†Œ</a>
                `;
            }
            navLinks.innerHTML = html;
        }

        // åŠ è½½åˆ†ç±»åˆ—è¡¨
        async function loadCategories() {
            const result = await ProductAPI.getCategoryList(true); // æ‰å¹³ç»“æ„
            if (result.success) {
                const select = document.getElementById('filterCategory');
                // æŒ‰ path æ’åºç¡®ä¿çˆ¶å­åˆ†ç±»ä½ç½®æ­£ç¡®
                const sorted = result.data.sort((a, b) => (a.path || '').localeCompare(b.path || ''));
                sorted.forEach(cat => {
                    const level = cat.level || 1;
                    let prefix = '';
                    if (level === 2) prefix = 'ã€€â”œâ”€ ';
                    if (level === 3) prefix = 'ã€€ã€€â””â”€ ';
                    select.innerHTML += `<option value="${cat.id}">${prefix}${cat.name}</option>`;
                });
            }
        }

        // åŠ è½½å•†å“åˆ—è¡¨
        async function loadProducts() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            const filters = {
                page: currentPage,
                page_size: pageSize,
                keyword: document.getElementById('searchKeyword').value,
                category_id: document.getElementById('filterCategory').value,
                min_price: document.getElementById('minPrice').value,
                max_price: document.getElementById('maxPrice').value,
                has_stock: document.getElementById('filterStock').value,
                sort_by: document.getElementById('sortBy').value,
                sort_order: document.getElementById('sortOrder').value,
                status: 1 // åªæ˜¾ç¤ºä¸Šæ¶å•†å“
            };

            const result = await ProductAPI.getProductList(filters);

            if (result.success) {
                renderProducts(result.data.list);
                renderPagination(result.data.pagination);
            } else {
                grid.innerHTML = `<div class="empty-state">åŠ è½½å¤±è´¥ï¼š${result.message}</div>`;
            }
        }

        // æ¸²æŸ“å•†å“åˆ—è¡¨
        function renderProducts(products) {
            const grid = document.getElementById('productGrid');
            
            if (products.length === 0) {
                grid.innerHTML = '<div class="empty-state">æš‚æ— å•†å“</div>';
                return;
            }

            grid.innerHTML = products.map(product => `
                <div class="product-card" onclick="viewProduct(${product.id})">
                    <div class="product-image">
                        ${product.cover_image 
                            ? `<img src="${product.cover_image}" alt="${product.name}" />`
                            : '<div class="no-image">æš‚æ— å›¾ç‰‡</div>'
                        }
                        ${product.available_stock <= 0 ? '<span class="out-of-stock">å·²å”®ç½„</span>' : ''}
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">${escapeHtml(product.name)}</h3>
                        <p class="product-category">${product.category_name || 'æœªåˆ†ç±»'}</p>
                        <div class="product-price">
                            <span class="current-price">Â¥${product.price.toFixed(2)}</span>
                            ${product.original_price ? `<span class="original-price">Â¥${product.original_price.toFixed(2)}</span>` : ''}
                        </div>
                        <p class="product-stock">åº“å­˜: ${product.available_stock}</p>
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(pagination) {
            const paginationEl = document.getElementById('pagination');
            const { page, total_pages, total } = pagination;

            if (total_pages <= 1) {
                paginationEl.innerHTML = `<span class="page-info">å…± ${total} ä»¶å•†å“</span>`;
                return;
            }

            let html = `<span class="page-info">å…± ${total} ä»¶å•†å“</span>`;
            
            // ä¸Šä¸€é¡µ
            if (page > 1) {
                html += `<button class="page-btn" onclick="goToPage(${page - 1})">ä¸Šä¸€é¡µ</button>`;
            }

            // é¡µç 
            const startPage = Math.max(1, page - 2);
            const endPage = Math.min(total_pages, page + 2);

            if (startPage > 1) {
                html += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) html += '<span class="page-ellipsis">...</span>';
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === page ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            if (endPage < total_pages) {
                if (endPage < total_pages - 1) html += '<span class="page-ellipsis">...</span>';
                html += `<button class="page-btn" onclick="goToPage(${total_pages})">${total_pages}</button>`;
            }

            // ä¸‹ä¸€é¡µ
            if (page < total_pages) {
                html += `<button class="page-btn" onclick="goToPage(${page + 1})">ä¸‹ä¸€é¡µ</button>`;
            }

            paginationEl.innerHTML = html;
        }

        // è·³è½¬é¡µç 
        function goToPage(page) {
            currentPage = page;
            loadProducts();
            window.scrollTo(0, 0);
        }

        // æœç´¢
        function handleSearch() {
            currentPage = 1;
            loadProducts();
        }

        // æŸ¥çœ‹å•†å“è¯¦æƒ…
        function viewProduct(id) {
            window.location.href = `product-detail.html?id=${id}`;
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            await API.logout();
            Auth.clearUser();
            window.location.reload();
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
