<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»ç®¡ç† - Shop åå°</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="admin-header">
        <a href="index.html" class="logo">ğŸ›’ Shop <span>åå°ç®¡ç†</span></a>
        <div class="user-info">
            <span class="username" id="adminName">ç®¡ç†å‘˜</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <aside class="admin-sidebar">
        <a href="index.html" class="menu-item">ğŸ“Š æ§åˆ¶å°</a>
        <a href="users.html" class="menu-item">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
        <a href="categories.html" class="menu-item active">ğŸ·ï¸ åˆ†ç±»ç®¡ç†</a>
        <a href="products.html" class="menu-item">ğŸ“¦ å•†å“ç®¡ç†</a>
        <a href="orders.html" class="menu-item">ğŸ“‹ è®¢å•ç®¡ç†</a>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="admin-main">
        <div class="page-header">
            <h1>åˆ†ç±»ç®¡ç†</h1>
            <p>ç®¡ç†å•†å“åˆ†ç±»ï¼Œæ”¯æŒå¤šçº§åˆ†ç±»</p>
        </div>

        <!-- æ“ä½œæ  -->
        <div class="toolbar">
            <button class="btn btn-primary" onclick="showAddModal()">+ æ·»åŠ åˆ†ç±»</button>
        </div>

        <!-- åˆ†ç±»åˆ—è¡¨ -->
        <div class="card">
            <div class="card-body">
                <div class="loading" id="loading">åŠ è½½ä¸­...</div>
                <table class="table" id="categoryTable" style="display: none;">
                    <thead>
                        <tr>
                            <th width="80">ID</th>
                            <th>åˆ†ç±»åç§°</th>
                            <th width="60">å±‚çº§</th>
                            <th>çˆ¶åˆ†ç±»</th>
                            <th width="80">æ’åº</th>
                            <th width="80">çŠ¶æ€</th>
                            <th width="160">åˆ›å»ºæ—¶é—´</th>
                            <th width="150">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="categoryBody">
                    </tbody>
                </table>
                <div class="empty" id="emptyState" style="display: none;">æš‚æ— åˆ†ç±»æ•°æ®</div>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ /ç¼–è¾‘å¼¹çª— -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ åˆ†ç±»</h3>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId" />
                    <div class="form-group">
                        <label>åˆ†ç±»åç§° <span class="required">*</span></label>
                        <input type="text" id="categoryName" placeholder="è¯·è¾“å…¥åˆ†ç±»åç§°" required />
                    </div>
                    <div class="form-group">
                        <label>çˆ¶åˆ†ç±»</label>
                        <select id="parentCategory">
                            <option value="0">é¡¶çº§åˆ†ç±»</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ’åº</label>
                        <input type="number" id="sortOrder" value="0" placeholder="æ•°å­—è¶Šå°è¶Šé å‰" />
                    </div>
                    <div class="form-group">
                        <label>çŠ¶æ€</label>
                        <select id="categoryStatus">
                            <option value="1">æ˜¾ç¤º</option>
                            <option value="0">éšè—</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åˆ†ç±»æè¿°</label>
                        <input type="text" id="categoryDescription" placeholder="åˆ†ç±»æè¿°ï¼ˆå¯é€‰ï¼‰" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="hideModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveCategory()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script src="js/admin-api.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•
        if (!AdminAuth.requireLogin()) {
            console.log('æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
        }

        // åˆ†ç±»æ•°æ®ç¼“å­˜
        let categories = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åŠ è½½æ•°æ®...');
            loadAdminInfo();
            loadCategories();
        });

        function loadAdminInfo() {
            const user = AdminAuth.getUser();
            console.log('å½“å‰ç”¨æˆ·:', user);
            if (user) {
                document.getElementById('adminName').textContent = user.username;
            }
        }

        // åŠ è½½åˆ†ç±»åˆ—è¡¨
        async function loadCategories() {
            console.log('å¼€å§‹è¯·æ±‚åˆ†ç±»åˆ—è¡¨...');
            const result = await AdminAPI.getCategoryList(true, true);
            console.log('åˆ†ç±»åˆ—è¡¨è¿”å›:', result);
            
            document.getElementById('loading').style.display = 'none';
            
            if (result.success) {
                categories = result.data;
                if (categories.length > 0) {
                    renderCategories();
                    document.getElementById('categoryTable').style.display = 'table';
                } else {
                    document.getElementById('emptyState').style.display = 'block';
                }
            } else {
                alert('åŠ è½½å¤±è´¥ï¼š' + result.message);
            }
        }

        // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
        function renderCategories() {
            const tbody = document.getElementById('categoryBody');
            
            // æ„å»ºçˆ¶åˆ†ç±»æ˜ å°„
            const parentMap = {};
            categories.forEach(cat => {
                parentMap[cat.id] = cat.name;
            });

            // æŒ‰ path æ’åºç¡®ä¿çˆ¶åœ¨å­å‰
            const sorted = [...categories].sort((a, b) => (a.path || '').localeCompare(b.path || ''));

            const levelLabels = { 1: 'ä¸€çº§', 2: 'äºŒçº§', 3: 'ä¸‰çº§' };

            tbody.innerHTML = sorted.map(cat => {
                const parentName = cat.parent_id > 0 ? (parentMap[cat.parent_id] || '-') : '-';
                const indent = 'ã€€'.repeat((cat.level || 1) - 1) + (cat.level > 1 ? 'â”œâ”€ ' : '');
                const levelText = levelLabels[cat.level] || `${cat.level}çº§`;
                return `
                    <tr>
                        <td>${cat.id}</td>
                        <td>${indent}${escapeHtml(cat.name)}</td>
                        <td><span class="tag ${cat.level === 1 ? 'tag-primary' : cat.level === 2 ? 'tag-warning' : 'tag-default'}">${levelText}</span></td>
                        <td>${parentName}</td>
                        <td>${cat.sort_order}</td>
                        <td>
                            <span class="tag ${cat.status === 1 ? 'tag-success' : 'tag-danger'}">
                                ${cat.status === 1 ? 'æ˜¾ç¤º' : 'éšè—'}
                            </span>
                        </td>
                        <td>${cat.created_at || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editCategory(${cat.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id}, '${escapeHtml(cat.name)}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ˜¾ç¤ºæ·»åŠ å¼¹çª—
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ åˆ†ç±»';
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryForm').reset();
            document.getElementById('sortOrder').value = '0';
            document.getElementById('categoryStatus').value = '1';
            updateParentSelect();
            document.getElementById('categoryModal').classList.add('show');
        }

        // ç¼–è¾‘åˆ†ç±»
        async function editCategory(id) {
            const result = await AdminAPI.getCategoryDetail(id);
            if (!result.success) {
                alert('è·å–åˆ†ç±»ä¿¡æ¯å¤±è´¥');
                return;
            }

            const cat = result.data;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘åˆ†ç±»';
            document.getElementById('categoryId').value = cat.id;
            document.getElementById('categoryName').value = cat.name;
            document.getElementById('sortOrder').value = cat.sort_order;
            document.getElementById('categoryStatus').value = cat.status;
            document.getElementById('categoryDescription').value = cat.description || '';
            
            updateParentSelect(cat.id);
            document.getElementById('parentCategory').value = cat.parent_id;
            
            document.getElementById('categoryModal').classList.add('show');
        }

        // æ›´æ–°çˆ¶åˆ†ç±»é€‰æ‹©æ¡†
        function updateParentSelect(excludeId = null) {
            const select = document.getElementById('parentCategory');
            select.innerHTML = '<option value="0">é¡¶çº§åˆ†ç±»</option>';
            
            // æ˜¾ç¤ºä¸€çº§å’ŒäºŒçº§åˆ†ç±»ä½œä¸ºå¯é€‰çˆ¶åˆ†ç±»ï¼ˆæœ€å¤šä¸‰çº§ï¼‰
            const sorted = [...categories].sort((a, b) => (a.path || '').localeCompare(b.path || ''));
            sorted.filter(cat => cat.id !== excludeId && (cat.level || 1) < 3).forEach(cat => {
                const indent = 'ã€€'.repeat((cat.level || 1) - 1);
                select.innerHTML += `<option value="${cat.id}">${indent}${escapeHtml(cat.name)}</option>`;
            });
        }

        // éšè—å¼¹çª—
        function hideModal() {
            document.getElementById('categoryModal').classList.remove('show');
        }

        // ä¿å­˜åˆ†ç±»
        async function saveCategory() {
            const id = document.getElementById('categoryId').value;
            const name = document.getElementById('categoryName').value.trim();
            const parentId = document.getElementById('parentCategory').value;
            const sortOrder = document.getElementById('sortOrder').value;
            const status = document.getElementById('categoryStatus').value;

            if (!name) {
                alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
                return;
            }

            const data = {
                name: name,
                parent_id: parseInt(parentId),
                sort_order: parseInt(sortOrder),
                status: parseInt(status),
                description: document.getElementById('categoryDescription').value.trim()
            };

            let result;
            if (id) {
                data.id = parseInt(id);
                result = await AdminAPI.updateCategory(data);
            } else {
                result = await AdminAPI.addCategory(data);
            }

            if (result.success) {
                alert(id ? 'ä¿®æ”¹æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ');
                hideModal();
                loadCategories();
            } else {
                alert(result.message);
            }
        }

        // åˆ é™¤åˆ†ç±»
        async function deleteCategory(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±»ã€Œ${name}ã€å—ï¼Ÿ`)) {
                return;
            }

            const result = await AdminAPI.deleteCategory(id);
            if (result.success) {
                alert('åˆ é™¤æˆåŠŸ');
                loadCategories();
            } else {
                alert(result.message);
            }
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            await AdminAPI.logout();
            AdminAuth.clearUser();
            window.location.href = 'login.html';
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
