<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“ç‰Œç®¡ç† - Shop åå°</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="admin-header">
        <a href="index.html" class="logo">ğŸ›’ Shop <span>åå°ç®¡ç†</span></a>
        <div class="user-info">
            <span class="username" id="adminName">ç®¡ç†å‘˜</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <aside class="admin-sidebar">
        <a href="index.html" class="menu-item">ğŸ“Š æ§åˆ¶å°</a>
        <a href="users.html" class="menu-item">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
        <a href="categories.html" class="menu-item">ğŸ·ï¸ åˆ†ç±»ç®¡ç†</a>
        <a href="brands.html" class="menu-item active">ğŸ¢ å“ç‰Œç®¡ç†</a>
        <a href="attributes.html" class="menu-item">ğŸ“‹ å±æ€§ç®¡ç†</a>
        <a href="products.html" class="menu-item">ğŸ“¦ å•†å“ç®¡ç†</a>
        <a href="orders.html" class="menu-item">ğŸ“‹ è®¢å•ç®¡ç†</a>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="admin-main">
        <div class="page-header">
            <h1>å“ç‰Œç®¡ç†</h1>
            <p>ç®¡ç†æ‰€æœ‰å“ç‰Œä¿¡æ¯</p>
        </div>

        <!-- æ“ä½œæ  -->
        <div class="toolbar">
            <div class="toolbar-left">
                <span class="page-info" id="brandCount">å…± 0 ä¸ªå“ç‰Œ</span>
            </div>
            <div class="toolbar-right">
                <button class="btn btn-primary" onclick="showAddModal()">+ æ·»åŠ å“ç‰Œ</button>
            </div>
        </div>

        <!-- å“ç‰Œåˆ—è¡¨ -->
        <div class="card">
            <div class="card-body">
                <div class="loading" id="loading">åŠ è½½ä¸­...</div>
                <table class="table" id="brandTable" style="display: none;">
                    <thead>
                        <tr>
                            <th width="60">ID</th>
                            <th width="80">Logo</th>
                            <th>å“ç‰Œåç§°</th>
                            <th>è‹±æ–‡å</th>
                            <th>æè¿°</th>
                            <th width="60">æ’åº</th>
                            <th width="80">å•†å“æ•°</th>
                            <th width="80">çŠ¶æ€</th>
                            <th width="140">åˆ›å»ºæ—¶é—´</th>
                            <th width="180">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="brandBody"></tbody>
                </table>
                <div class="empty" id="emptyState" style="display: none;">æš‚æ— å“ç‰Œæ•°æ®</div>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ /ç¼–è¾‘å“ç‰Œå¼¹çª— -->
    <div class="modal" id="brandModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ å“ç‰Œ</h3>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="brandForm">
                    <input type="hidden" id="brandId" />
                    <div class="form-group">
                        <label>å“ç‰Œåç§° <span class="required">*</span></label>
                        <input type="text" id="brandName" placeholder="è¯·è¾“å…¥å“ç‰Œåç§°" required />
                    </div>
                    <div class="form-group">
                        <label>è‹±æ–‡åç§°</label>
                        <input type="text" id="brandNameEn" placeholder="Brand English Name" />
                    </div>
                    <div class="form-group">
                        <label>å“ç‰ŒLogo</label>
                        <div class="image-upload">
                            <input type="file" id="logoFile" accept="image/*" onchange="handleLogoUpload()" />
                            <input type="hidden" id="logoUrl" />
                            <div class="image-preview" id="logoPreview">
                                <span>ç‚¹å‡»ä¸Šä¼ Logo</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å“ç‰Œæè¿°</label>
                        <textarea id="brandDescription" rows="3" placeholder="è¯·è¾“å…¥å“ç‰Œæè¿°"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ’åºå€¼</label>
                            <input type="number" id="brandSortOrder" min="0" value="0" />
                        </div>
                        <div class="form-group">
                            <label>çŠ¶æ€</label>
                            <select id="brandStatus">
                                <option value="1">å¯ç”¨</option>
                                <option value="0">ç¦ç”¨</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="hideModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveBrand()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script src="js/admin-api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            if (!await AdminAuth.requireLoginAsync()) return;
            loadAdminInfo();
            loadBrands();
        });

        function loadAdminInfo() {
            const user = AdminAuth.getUser();
            if (user) document.getElementById('adminName').textContent = user.username;
        }

        // åŠ è½½å“ç‰Œåˆ—è¡¨
        async function loadBrands() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('brandTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            const result = await AdminAPI.getBrandList(true);
            document.getElementById('loading').style.display = 'none';

            if (result.success) {
                const brands = result.data;
                document.getElementById('brandCount').textContent = `å…± ${brands.length} ä¸ªå“ç‰Œ`;

                if (brands.length > 0) {
                    renderBrands(brands);
                    document.getElementById('brandTable').style.display = 'table';
                } else {
                    document.getElementById('emptyState').style.display = 'block';
                }
            } else {
                alert('åŠ è½½å¤±è´¥ï¼š' + result.message);
            }
        }

        // æ¸²æŸ“å“ç‰Œåˆ—è¡¨
        function renderBrands(brands) {
            // éœ€è¦é€ä¸ªè·å–å•†å“æ•°é‡ï¼Œè¿™é‡Œç”¨å“ç‰Œè¯¦æƒ…æ¥è·å–
            const tbody = document.getElementById('brandBody');
            tbody.innerHTML = brands.map(b => `
                <tr>
                    <td>${b.id}</td>
                    <td>
                        <div class="product-thumb">
                            ${b.logo 
                                ? `<img src="${b.logo}" alt="" />` 
                                : '<span class="no-image">æ— </span>'
                            }
                        </div>
                    </td>
                    <td><strong>${escapeHtml(b.name)}</strong></td>
                    <td>${escapeHtml(b.name_en || '-')}</td>
                    <td><span style="color:#666;font-size:13px;">${escapeHtml(b.description || '-')}</span></td>
                    <td>${b.sort_order}</td>
                    <td><span class="brand-product-count" id="brandPc_${b.id}">-</span></td>
                    <td>
                        <span class="tag ${b.status === 1 ? 'tag-success' : 'tag-danger'}">
                            ${b.status === 1 ? 'å¯ç”¨' : 'ç¦ç”¨'}
                        </span>
                    </td>
                    <td>${formatDate(b.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editBrand(${b.id})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBrand(${b.id}, '${escapeHtml(b.name)}')">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');

            // å¼‚æ­¥åŠ è½½å•†å“æ•°é‡
            brands.forEach(async b => {
                const detail = await AdminAPI.getBrandDetail(b.id);
                if (detail.success) {
                    const el = document.getElementById(`brandPc_${b.id}`);
                    if (el) el.textContent = detail.data.product_count;
                }
            });
        }

        // æ˜¾ç¤ºæ·»åŠ å¼¹çª—
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ å“ç‰Œ';
            document.getElementById('brandId').value = '';
            document.getElementById('brandForm').reset();
            document.getElementById('brandSortOrder').value = '0';
            document.getElementById('brandStatus').value = '1';
            document.getElementById('logoUrl').value = '';
            document.getElementById('logoPreview').innerHTML = '<span>ç‚¹å‡»ä¸Šä¼ Logo</span>';
            document.getElementById('brandModal').classList.add('show');
        }

        // ç¼–è¾‘å“ç‰Œ
        async function editBrand(id) {
            const result = await AdminAPI.getBrandDetail(id);
            if (!result.success) {
                alert('è·å–å“ç‰Œä¿¡æ¯å¤±è´¥');
                return;
            }

            const b = result.data;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å“ç‰Œ';
            document.getElementById('brandId').value = b.id;
            document.getElementById('brandName').value = b.name;
            document.getElementById('brandNameEn').value = b.name_en || '';
            document.getElementById('brandDescription').value = b.description || '';
            document.getElementById('brandSortOrder').value = b.sort_order;
            document.getElementById('brandStatus').value = b.status;
            document.getElementById('logoUrl').value = b.logo || '';

            if (b.logo) {
                document.getElementById('logoPreview').innerHTML = `<img src="${b.logo}" alt="Logo" />`;
            } else {
                document.getElementById('logoPreview').innerHTML = '<span>ç‚¹å‡»ä¸Šä¼ Logo</span>';
            }

            document.getElementById('brandModal').classList.add('show');
        }

        // Logoä¸Šä¼ 
        async function handleLogoUpload() {
            const file = document.getElementById('logoFile').files[0];
            if (!file) return;

            document.getElementById('logoPreview').innerHTML = '<span>ä¸Šä¼ ä¸­...</span>';
            const result = await AdminAPI.uploadImage(file);
            if (result.success) {
                document.getElementById('logoUrl').value = result.data.url;
                document.getElementById('logoPreview').innerHTML = `<img src="${result.data.url}" alt="Logo" />`;
            } else {
                alert('ä¸Šä¼ å¤±è´¥ï¼š' + result.message);
                document.getElementById('logoPreview').innerHTML = '<span>ç‚¹å‡»ä¸Šä¼ Logo</span>';
            }
        }

        function hideModal() {
            document.getElementById('brandModal').classList.remove('show');
        }

        // ä¿å­˜å“ç‰Œ
        async function saveBrand() {
            const id = document.getElementById('brandId').value;
            const name = document.getElementById('brandName').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å“ç‰Œåç§°');
                return;
            }

            const data = {
                name: name,
                name_en: document.getElementById('brandNameEn').value.trim(),
                logo: document.getElementById('logoUrl').value,
                description: document.getElementById('brandDescription').value.trim(),
                sort_order: parseInt(document.getElementById('brandSortOrder').value) || 0,
                status: parseInt(document.getElementById('brandStatus').value)
            };

            let result;
            if (id) {
                data.id = parseInt(id);
                result = await AdminAPI.updateBrand(data);
            } else {
                result = await AdminAPI.addBrand(data);
            }

            if (result.success) {
                alert(id ? 'ä¿®æ”¹æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ');
                hideModal();
                loadBrands();
            } else {
                alert(result.message);
            }
        }

        // åˆ é™¤å“ç‰Œ
        async function deleteBrand(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å“ç‰Œã€Œ${name}ã€å—ï¼Ÿ`)) return;

            const result = await AdminAPI.deleteBrand(id);
            if (result.success) {
                alert('åˆ é™¤æˆåŠŸ');
                loadBrands();
            } else {
                alert(result.message);
            }
        }

        async function handleLogout() {
            await AdminAPI.logout();
            AdminAuth.clearUser();
            window.location.href = 'login.html';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return dateStr.substring(0, 10);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
