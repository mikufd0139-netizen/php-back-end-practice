<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±æ€§ç®¡ç† - Shop åå°</title>
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .attr-panel { display: flex; gap: 20px; }
        .attr-panel .left-panel { width: 300px; flex-shrink: 0; }
        .attr-panel .right-panel { flex: 1; }
        .category-selector { margin-bottom: 15px; }
        .category-selector select { width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px; }
        .attr-item { background: #fff; border: 1px solid #e8e8e8; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .attr-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .attr-item-header h4 { margin: 0; font-size: 15px; }
        .attr-item-actions { display: flex; gap: 6px; }
        .attr-values { display: flex; flex-wrap: wrap; gap: 8px; }
        .attr-value-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; background: #f0f5ff; border: 1px solid #adc6ff; border-radius: 4px; font-size: 13px; color: #1890ff; }
        .attr-value-tag .remove-btn { cursor: pointer; color: #999; font-size: 16px; line-height: 1; }
        .attr-value-tag .remove-btn:hover { color: #ff4d4f; }
        .add-value-input { display: inline-flex; align-items: center; gap: 4px; }
        .add-value-input input { width: 100px; padding: 4px 8px; border: 1px dashed #d9d9d9; border-radius: 4px; font-size: 13px; }
        .add-value-input button { padding: 4px 8px; font-size: 12px; background: #1890ff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        .empty-tip { color: #999; text-align: center; padding: 40px; }
        .inline-edit { display: flex; gap: 6px; align-items: center; }
        .inline-edit input { padding: 4px 8px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px; }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="admin-header">
        <a href="index.html" class="logo">ğŸ›’ Shop <span>åå°ç®¡ç†</span></a>
        <div class="user-info">
            <span class="username" id="adminName">ç®¡ç†å‘˜</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <aside class="admin-sidebar">
        <a href="index.html" class="menu-item">ğŸ“Š æ§åˆ¶å°</a>
        <a href="users.html" class="menu-item">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
        <a href="categories.html" class="menu-item">ğŸ·ï¸ åˆ†ç±»ç®¡ç†</a>
        <a href="brands.html" class="menu-item">ğŸ¢ å“ç‰Œç®¡ç†</a>
        <a href="attributes.html" class="menu-item active">ğŸ“‹ å±æ€§ç®¡ç†</a>
        <a href="products.html" class="menu-item">ğŸ“¦ å•†å“ç®¡ç†</a>
        <a href="orders.html" class="menu-item">ğŸ“‹ è®¢å•ç®¡ç†</a>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="admin-main">
        <div class="page-header">
            <h1>å±æ€§ç®¡ç†</h1>
            <p>ç®¡ç†å•†å“åˆ†ç±»çš„è§„æ ¼å±æ€§ï¼ˆå¦‚ï¼šé¢œè‰²ã€å°ºç ã€å®¹é‡ç­‰ï¼‰ï¼Œç”¨äºSKUç»„åˆ</p>
        </div>

        <div class="attr-panel">
            <!-- å·¦ä¾§ï¼šé€‰æ‹©åˆ†ç±» & æ·»åŠ å±æ€§ -->
            <div class="left-panel">
                <div class="card">
                    <div class="card-body">
                        <h3 style="margin-bottom:15px;">é€‰æ‹©åˆ†ç±»</h3>
                        <div class="category-selector">
                            <select id="categorySelect" onchange="loadAttributes()">
                                <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                            </select>
                        </div>
                        <hr style="margin:15px 0;border:none;border-top:1px solid #f0f0f0;" />
                        <h3 style="margin-bottom:10px;">æ·»åŠ å±æ€§</h3>
                        <div class="form-group" style="margin-bottom:10px;">
                            <input type="text" id="newAttrName" placeholder="å±æ€§åç§°ï¼Œå¦‚ï¼šé¢œè‰²" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:4px;" />
                        </div>
                        <div class="form-group" style="margin-bottom:10px;">
                            <input type="text" id="newAttrValues" placeholder="å±æ€§å€¼ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼Œå¦‚ï¼šçº¢,è“,ç»¿" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:4px;" />
                        </div>
                        <div class="form-group" style="margin-bottom:10px;">
                            <input type="number" id="newAttrSort" value="0" min="0" placeholder="æ’åº" style="width:100%;padding:8px;border:1px solid #d9d9d9;border-radius:4px;" />
                        </div>
                        <button class="btn btn-primary" style="width:100%;" onclick="addAttribute()">+ æ·»åŠ å±æ€§</button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå±æ€§åˆ—è¡¨ -->
            <div class="right-panel">
                <div class="card">
                    <div class="card-body">
                        <div class="loading" id="loading" style="display:none;">åŠ è½½ä¸­...</div>
                        <div class="empty-tip" id="emptyTip">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†ç±»</div>
                        <div id="attrList"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/admin-api.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•
        if (!AdminAuth.requireLogin()) {}

        let categories = [];
        let currentCategoryId = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadAdminInfo();
            loadCategories();
        });

        function loadAdminInfo() {
            const user = AdminAuth.getUser();
            if (user) document.getElementById('adminName').textContent = user.username;
        }

        // åŠ è½½åˆ†ç±»
        async function loadCategories() {
            const result = await AdminAPI.getCategoryList(true, true);
            if (result.success) {
                categories = result.data;
                const select = document.getElementById('categorySelect');
                const sorted = [...categories].sort((a, b) => (a.path || '').localeCompare(b.path || ''));
                sorted.forEach(cat => {
                    const indent = 'ã€€'.repeat((cat.level || 1) - 1);
                    select.innerHTML += `<option value="${cat.id}">${indent}${escapeHtml(cat.name)}</option>`;
                });
            }
        }

        // åŠ è½½å±æ€§åˆ—è¡¨
        async function loadAttributes() {
            const categoryId = document.getElementById('categorySelect').value;
            const listEl = document.getElementById('attrList');
            const emptyTip = document.getElementById('emptyTip');
            const loading = document.getElementById('loading');

            if (!categoryId) {
                listEl.innerHTML = '';
                emptyTip.style.display = 'block';
                emptyTip.textContent = 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†ç±»';
                currentCategoryId = null;
                return;
            }

            currentCategoryId = parseInt(categoryId);
            emptyTip.style.display = 'none';
            loading.style.display = 'block';
            listEl.innerHTML = '';

            const result = await AdminAPI.getAttributeList(categoryId);
            loading.style.display = 'none';

            if (!result.success) {
                listEl.innerHTML = `<div class="empty-tip" style="color:#ff4d4f;">${result.message}</div>`;
                return;
            }

            const attrs = result.data;
            if (attrs.length === 0) {
                emptyTip.style.display = 'block';
                emptyTip.textContent = 'è¯¥åˆ†ç±»æš‚æ— å±æ€§ï¼Œè¯·åœ¨å·¦ä¾§æ·»åŠ ';
                return;
            }

            listEl.innerHTML = attrs.map(attr => `
                <div class="attr-item" id="attr_${attr.id}">
                    <div class="attr-item-header">
                        <h4>
                            <span id="attrName_${attr.id}">${escapeHtml(attr.name)}</span>
                            <small style="color:#999;margin-left:8px;">æ’åº: ${attr.sort_order}</small>
                        </h4>
                        <div class="attr-item-actions">
                            <button class="btn btn-sm" onclick="editAttribute(${attr.id}, '${escapeHtml(attr.name)}', ${attr.sort_order})">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAttribute(${attr.id}, '${escapeHtml(attr.name)}')">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="attr-values">
                        ${attr.values.map(v => `
                            <span class="attr-value-tag">
                                ${escapeHtml(v.value)}
                                <span class="remove-btn" onclick="deleteAttrValue(${v.id}, '${escapeHtml(v.value)}')" title="åˆ é™¤">&times;</span>
                            </span>
                        `).join('')}
                        <div class="add-value-input">
                            <input type="text" id="newVal_${attr.id}" placeholder="æ–°å¢å€¼" onkeypress="if(event.key==='Enter')addAttrValue(${attr.id})" />
                            <button onclick="addAttrValue(${attr.id})">+</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ·»åŠ å±æ€§
        async function addAttribute() {
            if (!currentCategoryId) {
                alert('è¯·å…ˆé€‰æ‹©åˆ†ç±»');
                return;
            }

            const name = document.getElementById('newAttrName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥å±æ€§åç§°');
                return;
            }

            const valuesStr = document.getElementById('newAttrValues').value.trim();
            const sortOrder = parseInt(document.getElementById('newAttrSort').value) || 0;
            const values = valuesStr ? valuesStr.split(/[,ï¼Œ]/).map(v => v.trim()).filter(v => v) : [];

            const result = await AdminAPI.addAttribute({
                category_id: currentCategoryId,
                name: name,
                sort_order: sortOrder,
                values: values
            });

            if (result.success) {
                document.getElementById('newAttrName').value = '';
                document.getElementById('newAttrValues').value = '';
                document.getElementById('newAttrSort').value = '0';
                loadAttributes();
            } else {
                alert(result.message);
            }
        }

        // ç¼–è¾‘å±æ€§
        async function editAttribute(id, name, sortOrder) {
            const newName = prompt('ä¿®æ”¹å±æ€§åç§°', name);
            if (newName === null) return;
            if (!newName.trim()) { alert('åç§°ä¸èƒ½ä¸ºç©º'); return; }

            const newSort = prompt('ä¿®æ”¹æ’åºå€¼', sortOrder);
            if (newSort === null) return;

            const result = await AdminAPI.updateAttribute({
                id: id,
                name: newName.trim(),
                sort_order: parseInt(newSort) || 0
            });

            if (result.success) {
                loadAttributes();
            } else {
                alert(result.message);
            }
        }

        // åˆ é™¤å±æ€§
        async function deleteAttribute(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å±æ€§ã€Œ${name}ã€åŠå…¶æ‰€æœ‰å±æ€§å€¼å—ï¼Ÿ\n\nâš ï¸ å¦‚æœæœ‰SKUå¼•ç”¨äº†æ­¤å±æ€§ï¼Œå°†æ— æ³•åˆ é™¤ã€‚`)) return;

            const result = await AdminAPI.deleteAttribute(id);
            if (result.success) {
                loadAttributes();
            } else {
                alert(result.message);
            }
        }

        // æ·»åŠ å±æ€§å€¼
        async function addAttrValue(attrId) {
            const input = document.getElementById(`newVal_${attrId}`);
            const value = input.value.trim();
            if (!value) return;

            const result = await AdminAPI.addAttributeValue({
                attribute_id: attrId,
                value: value
            });

            if (result.success) {
                input.value = '';
                loadAttributes();
            } else {
                alert(result.message);
            }
        }

        // åˆ é™¤å±æ€§å€¼
        async function deleteAttrValue(valueId, valueName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å±æ€§å€¼ã€Œ${valueName}ã€å—ï¼Ÿ`)) return;

            const result = await AdminAPI.deleteAttributeValue(valueId);
            if (result.success) {
                loadAttributes();
            } else {
                alert(result.message);
            }
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            await AdminAPI.logout();
            AdminAuth.clearUser();
            window.location.href = 'login.html';
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
