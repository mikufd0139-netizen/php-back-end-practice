<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - Shop åå°</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="admin-header">
        <a href="index.html" class="logo">ğŸ›’ Shop <span>åå°ç®¡ç†</span></a>
        <div class="user-info">
            <span class="username" id="adminName">ç®¡ç†å‘˜</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <aside class="admin-sidebar">
        <a href="index.html" class="menu-item">ğŸ“Š æ§åˆ¶å°</a>
        <a href="users.html" class="menu-item active">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
        <a href="categories.html" class="menu-item">ğŸ·ï¸ åˆ†ç±»ç®¡ç†</a>
        <a href="brands.html" class="menu-item">ğŸ¢ å“ç‰Œç®¡ç†</a>
        <a href="attributes.html" class="menu-item">ğŸ“‹ å±æ€§ç®¡ç†</a>
        <a href="products.html" class="menu-item">ğŸ“¦ å•†å“ç®¡ç†</a>
        <a href="orders.html" class="menu-item">ğŸ“‹ è®¢å•ç®¡ç†</a>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="admin-main">
        <div class="page-header">
            <h1>ç”¨æˆ·ç®¡ç†</h1>
            <p>ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç”¨æˆ·</p>
        </div>

        <!-- æ“ä½œæç¤º -->
        <div class="alert alert-success" id="successAlert" style="display: none;"></div>
        <div class="alert alert-error" id="errorAlert" style="display: none;"></div>

        <!-- ç”¨æˆ·åˆ—è¡¨ -->
        <div class="card">
            <div class="card-header">
                <h2>ç”¨æˆ·åˆ—è¡¨</h2>
                <span id="totalInfo">å…± 0 ä¸ªç”¨æˆ·</span>
            </div>
            <div class="card-body">
                <div class="loading" id="loading">åŠ è½½ä¸­...</div>
                <div class="empty" id="empty" style="display: none;">æš‚æ— ç”¨æˆ·æ•°æ®</div>
                
                <table class="table" id="usersTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>é‚®ç®±</th>
                            <th>æ‰‹æœºå·</th>
                            <th>è§’è‰²</th>
                            <th>çŠ¶æ€</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody">
                    </tbody>
                </table>

                <!-- åˆ†é¡µ -->
                <div class="pagination" id="pagination" style="display: none;">
                    <button id="prevBtn" onclick="prevPage()">ä¸Šä¸€é¡µ</button>
                    <span class="page-info" id="pageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                    <button id="nextBtn" onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </main>

    <script src="js/admin-api.js"></script>
    <script>
        // åˆ†é¡µçŠ¶æ€
        let currentPage = 1;
        let totalPages = 1;
        const pageSize = 10;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!AdminAuth.requireLogin()) {
            // ä¼šè‡ªåŠ¨è·³è½¬
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminInfo();
            loadUsers();
        });

        // åŠ è½½ç®¡ç†å‘˜ä¿¡æ¯
        function loadAdminInfo() {
            const user = AdminAuth.getUser();
            if (user) {
                document.getElementById('adminName').textContent = user.username;
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            showLoading();
            
            const result = await AdminAPI.getUsers(currentPage, pageSize);
            
            hideLoading();
            
            if (result.success) {
                const { users, total, page, total_pages } = result.data;
                
                currentPage = page;
                totalPages = total_pages;
                
                document.getElementById('totalInfo').textContent = `å…± ${total} ä¸ªç”¨æˆ·`;
                
                if (users.length === 0) {
                    document.getElementById('empty').style.display = 'block';
                    document.getElementById('usersTable').style.display = 'none';
                    document.getElementById('pagination').style.display = 'none';
                } else {
                    document.getElementById('empty').style.display = 'none';
                    document.getElementById('usersTable').style.display = 'table';
                    document.getElementById('pagination').style.display = 'flex';
                    
                    renderUsers(users);
                    updatePagination();
                }
            } else {
                showError(result.message);
                if (result.message.includes('ç™»å½•') || result.message.includes('æƒé™')) {
                    AdminAuth.clearUser();
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                }
            }
        }

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsers(users) {
            const tbody = document.getElementById('usersBody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email || '-'}</td>
                    <td>${user.phone || '-'}</td>
                    <td>
                        <span class="tag ${user.role === 1 ? 'tag-blue' : ''}">
                            ${user.role_name}
                        </span>
                    </td>
                    <td>
                        <span class="tag ${user.status === 1 ? 'tag-success' : 'tag-danger'}">
                            ${user.status_name}
                        </span>
                    </td>
                    <td>${user.created_at}</td>
                    <td>
                        ${user.role !== 1 ? `
                            ${user.status === 1 
                                ? `<button class="btn btn-danger btn-sm" onclick="disableUser(${user.id})">ç¦ç”¨</button>`
                                : `<button class="btn btn-success btn-sm" onclick="enableUser(${user.id})">å¯ç”¨</button>`
                            }
                        ` : '<span style="color:#999">-</span>'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination() {
            document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        // ä¸Šä¸€é¡µ
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadUsers();
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadUsers();
            }
        }

        // ç¦ç”¨ç”¨æˆ·
        async function disableUser(userId) {
            if (!confirm('ç¡®å®šè¦ç¦ç”¨è¯¥ç”¨æˆ·å—ï¼Ÿ')) return;
            
            const result = await AdminAPI.disableUser(userId);
            
            if (result.success) {
                showSuccess('ç”¨æˆ·å·²ç¦ç”¨');
                loadUsers();
            } else {
                showError(result.message);
            }
        }

        // å¯ç”¨ç”¨æˆ·
        async function enableUser(userId) {
            const result = await AdminAPI.enableUser(userId);
            
            if (result.success) {
                showSuccess('ç”¨æˆ·å·²å¯ç”¨');
                loadUsers();
            } else {
                showError(result.message);
            }
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            await AdminAPI.logout();
            AdminAuth.clearUser();
            window.location.href = 'login.html';
        }

        // UI è¾…åŠ©å‡½æ•°
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('usersTable').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 3000);
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 3000);
        }
    </script>
</body>
</html>
