<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç† - Shop åå°</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="admin-header">
        <a href="index.html" class="logo">ğŸ›’ Shop <span>åå°ç®¡ç†</span></a>
        <div class="user-info">
            <span class="username" id="adminName">ç®¡ç†å‘˜</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <aside class="admin-sidebar">
        <a href="index.html" class="menu-item">ğŸ“Š æ§åˆ¶å°</a>
        <a href="users.html" class="menu-item">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
        <a href="categories.html" class="menu-item">ğŸ·ï¸ åˆ†ç±»ç®¡ç†</a>
        <a href="products.html" class="menu-item active">ğŸ“¦ å•†å“ç®¡ç†</a>
        <a href="orders.html" class="menu-item">ğŸ“‹ è®¢å•ç®¡ç†</a>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="admin-main">
        <div class="page-header">
            <h1>å•†å“ç®¡ç†</h1>
            <p>ç®¡ç†æ‰€æœ‰å•†å“ä¿¡æ¯ã€åº“å­˜</p>
        </div>

        <!-- æœç´¢å’Œæ“ä½œæ  -->
        <div class="toolbar">
            <div class="toolbar-left">
                <input type="text" id="searchKeyword" class="form-input" placeholder="æœç´¢å•†å“åç§°..." />
                <select id="filterCategory" class="form-select">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                </select>
                <select id="filterStatus" class="form-select">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="1">å·²ä¸Šæ¶</option>
                    <option value="0">å·²ä¸‹æ¶</option>
                </select>
                <button class="btn btn-primary" onclick="handleSearch()">æœç´¢</button>
            </div>
            <div class="toolbar-right">
                <button class="btn btn-primary" onclick="showAddModal()">+ æ·»åŠ å•†å“</button>
            </div>
        </div>

        <!-- å•†å“åˆ—è¡¨ -->
        <div class="card">
            <div class="card-body">
                <div class="loading" id="loading">åŠ è½½ä¸­...</div>
                <table class="table" id="productTable" style="display: none;">
                    <thead>
                        <tr>
                            <th width="60">ID</th>
                            <th width="80">å›¾ç‰‡</th>
                            <th>å•†å“åç§°</th>
                            <th>åˆ†ç±»</th>
                            <th width="100">ä»·æ ¼</th>
                            <th width="60">é”€é‡</th>
                            <th width="80">åº“å­˜</th>
                            <th width="80">çŠ¶æ€</th>
                            <th width="80">æ ‡ç­¾</th>
                            <th width="140">åˆ›å»ºæ—¶é—´</th>
                            <th width="200">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="productBody">
                    </tbody>
                </table>
                <div class="empty" id="emptyState" style="display: none;">æš‚æ— å•†å“æ•°æ®</div>
                
                <!-- åˆ†é¡µ -->
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ /ç¼–è¾‘å•†å“å¼¹çª— -->
    <div class="modal" id="productModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ å•†å“</h3>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId" />
                    <div class="form-row">
                        <div class="form-group">
                            <label>å•†å“åç§° <span class="required">*</span></label>
                            <input type="text" id="productName" placeholder="è¯·è¾“å…¥å•†å“åç§°" required />
                        </div>
                        <div class="form-group">
                            <label>æ‰€å±åˆ†ç±»</label>
                            <select id="productCategory">
                                <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å‰¯æ ‡é¢˜/å–ç‚¹</label>
                        <input type="text" id="productSubtitle" placeholder="ä¸€å¥è¯æè¿°å•†å“å–ç‚¹" />
                    </div>
                    <div class="form-group">
                        <label>æœç´¢å…³é”®è¯</label>
                        <input type="text" id="productKeywords" placeholder="å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”" />
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>é”€å”®ä»·æ ¼ <span class="required">*</span></label>
                            <input type="number" id="productPrice" step="0.01" min="0" placeholder="0.00" required />
                        </div>
                        <div class="form-group">
                            <label>åŸä»·ï¼ˆåˆ’çº¿ä»·ï¼‰</label>
                            <input type="number" id="productOriginalPrice" step="0.01" min="0" placeholder="0.00" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>åˆå§‹åº“å­˜</label>
                            <input type="number" id="productStock" min="0" value="0" placeholder="0" />
                        </div>
                        <div class="form-group">
                            <label>çŠ¶æ€</label>
                            <select id="productStatus">
                                <option value="1">ä¸Šæ¶</option>
                                <option value="0">ä¸‹æ¶</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ¨è</label>
                            <select id="productRecommend">
                                <option value="0">å¦</option>
                                <option value="1">æ˜¯</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ–°å“</label>
                            <select id="productNew">
                                <option value="0">å¦</option>
                                <option value="1">æ˜¯</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>çƒ­é”€</label>
                            <select id="productHot">
                                <option value="0">å¦</option>
                                <option value="1">æ˜¯</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å°é¢å›¾ç‰‡</label>
                        <div class="image-upload">
                            <input type="file" id="coverImageFile" accept="image/*" onchange="handleImageUpload()" />
                            <input type="hidden" id="coverImageUrl" />
                            <div class="image-preview" id="imagePreview">
                                <span>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å•†å“æè¿°</label>
                        <textarea id="productDescription" rows="4" placeholder="è¯·è¾“å…¥å•†å“æè¿°"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="hideModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveProduct()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- åº“å­˜ç®¡ç†å¼¹çª— -->
    <div class="modal" id="stockModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>åº“å­˜ç®¡ç†</h3>
                <button class="modal-close" onclick="hideStockModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="stock-info">
                    <p>å•†å“ï¼š<strong id="stockProductName">-</strong></p>
                    <p>å½“å‰åº“å­˜ï¼š<strong id="currentStock">-</strong></p>
                    <p>é”å®šåº“å­˜ï¼š<strong id="lockedStock">-</strong></p>
                    <p>å¯ç”¨åº“å­˜ï¼š<strong id="availableStock">-</strong></p>
                </div>
                <hr />
                <form id="stockForm">
                    <input type="hidden" id="stockProductId" />
                    <div class="form-group">
                        <label>æ“ä½œç±»å‹</label>
                        <select id="stockType">
                            <option value="set">è®¾ç½®åº“å­˜</option>
                            <option value="add">å¢åŠ åº“å­˜</option>
                            <option value="reduce">å‡å°‘åº“å­˜</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ•°é‡ <span class="required">*</span></label>
                        <input type="number" id="stockQuantity" min="0" placeholder="è¯·è¾“å…¥æ•°é‡" required />
                    </div>
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <input type="text" id="stockReason" placeholder="æ“ä½œåŸå› ï¼ˆå¯é€‰ï¼‰" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="hideStockModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveStock()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script src="js/admin-api.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•
        if (!AdminAuth.requireLogin()) {}

        // çŠ¶æ€å˜é‡
        let currentPage = 1;
        const pageSize = 10;
        let categories = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadAdminInfo();
            loadCategories();
            loadProducts();

            // å›è½¦æœç´¢
            document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleSearch();
            });
        });

        function loadAdminInfo() {
            const user = AdminAuth.getUser();
            if (user) {
                document.getElementById('adminName').textContent = user.username;
            }
        }

        // åŠ è½½åˆ†ç±»
        async function loadCategories() {
            const result = await AdminAPI.getCategoryList(true, true);
            if (result.success) {
                categories = result.data;
                const filterSelect = document.getElementById('filterCategory');
                const productSelect = document.getElementById('productCategory');
                
                // æŒ‰ path æ’åºç¡®ä¿å±‚çº§æ­£ç¡®
                const sorted = [...categories].sort((a, b) => (a.path || '').localeCompare(b.path || ''));
                sorted.forEach(cat => {
                    const indent = 'ã€€'.repeat((cat.level || 1) - 1);
                    filterSelect.innerHTML += `<option value="${cat.id}">${indent}${escapeHtml(cat.name)}</option>`;
                    productSelect.innerHTML += `<option value="${cat.id}">${indent}${escapeHtml(cat.name)}</option>`;
                });
            }
        }

        // åŠ è½½å•†å“åˆ—è¡¨
        async function loadProducts() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('productTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            const filters = {
                page: currentPage,
                page_size: pageSize,
                keyword: document.getElementById('searchKeyword').value,
                category_id: document.getElementById('filterCategory').value,
                status: document.getElementById('filterStatus').value
            };

            const result = await AdminAPI.getProductList(filters);
            
            document.getElementById('loading').style.display = 'none';

            if (result.success) {
                if (result.data.list.length > 0) {
                    renderProducts(result.data.list);
                    renderPagination(result.data.pagination);
                    document.getElementById('productTable').style.display = 'table';
                } else {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('pagination').innerHTML = '';
                }
            } else {
                alert('åŠ è½½å¤±è´¥ï¼š' + result.message);
            }
        }

        // æ¸²æŸ“å•†å“åˆ—è¡¨
        function renderProducts(products) {
            const tbody = document.getElementById('productBody');
            tbody.innerHTML = products.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>
                        <div class="product-thumb">
                            ${p.cover_image 
                                ? `<img src="${p.cover_image}" alt="" />` 
                                : '<span class="no-image">æ— å›¾</span>'
                            }
                        </div>
                    </td>
                    <td>
                        <div class="product-name-cell">
                            <span class="product-name">${escapeHtml(p.name)}</span>
                        </div>
                    </td>
                    <td>${p.category_name || '-'}</td>
                    <td>
                        <span class="price">Â¥${p.price.toFixed(2)}</span>
                        ${p.original_price ? `<br><span class="original-price">Â¥${p.original_price.toFixed(2)}</span>` : ''}
                    </td>
                    <td>${p.sales_count || 0}</td>
                    <td>
                        <span class="${p.available_stock > 0 ? 'text-success' : 'text-danger'}">${p.available_stock}</span>
                        ${p.locked_stock > 0 ? `<br><small class="text-muted">é”å®š:${p.locked_stock}</small>` : ''}
                    </td>
                    <td>
                        <span class="tag ${p.status === 1 ? 'tag-success' : 'tag-danger'}">
                            ${p.status === 1 ? 'ä¸Šæ¶' : 'ä¸‹æ¶'}
                        </span>
                    </td>
                    <td>
                        ${p.is_recommend ? '<span class="tag tag-primary" style="font-size:11px">è</span>' : ''}
                        ${p.is_new ? '<span class="tag tag-success" style="font-size:11px">æ–°</span>' : ''}
                        ${p.is_hot ? '<span class="tag tag-danger" style="font-size:11px">çƒ­</span>' : ''}
                    </td>
                    <td>${formatDate(p.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editProduct(${p.id})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-success" onclick="manageStock(${p.id})">åº“å­˜</button>
                        <button class="btn btn-sm ${p.status === 1 ? 'btn-warning' : 'btn-success'}" onclick="toggleStatus(${p.id})">
                            ${p.status === 1 ? 'ä¸‹æ¶' : 'ä¸Šæ¶'}
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id}, '${escapeHtml(p.name)}')">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(pagination) {
            const { page, total_pages, total } = pagination;
            if (total_pages <= 1) {
                document.getElementById('pagination').innerHTML = `<span class="page-info">å…± ${total} æ¡</span>`;
                return;
            }

            let html = `<span class="page-info">å…± ${total} æ¡</span>`;
            html += `<button ${page <= 1 ? 'disabled' : ''} onclick="goToPage(${page - 1})">ä¸Šä¸€é¡µ</button>`;
            html += `<span class="page-info">ç¬¬ ${page} / ${total_pages} é¡µ</span>`;
            html += `<button ${page >= total_pages ? 'disabled' : ''} onclick="goToPage(${page + 1})">ä¸‹ä¸€é¡µ</button>`;
            
            document.getElementById('pagination').innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadProducts();
        }

        function handleSearch() {
            currentPage = 1;
            loadProducts();
        }

        // æ˜¾ç¤ºæ·»åŠ å¼¹çª—
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ å•†å“';
            document.getElementById('productId').value = '';
            document.getElementById('productForm').reset();
            document.getElementById('productStock').value = '0';
            document.getElementById('productStatus').value = '1';
            document.getElementById('productRecommend').value = '0';
            document.getElementById('productNew').value = '0';
            document.getElementById('productHot').value = '0';
            document.getElementById('coverImageUrl').value = '';
            document.getElementById('imagePreview').innerHTML = '<span>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</span>';
            document.getElementById('productModal').classList.add('show');
        }

        // ç¼–è¾‘å•†å“
        async function editProduct(id) {
            const result = await AdminAPI.getProductDetail(id);
            if (!result.success) {
                alert('è·å–å•†å“ä¿¡æ¯å¤±è´¥');
                return;
            }

            const p = result.data;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å•†å“';
            document.getElementById('productId').value = p.id;
            document.getElementById('productName').value = p.name;
            document.getElementById('productCategory').value = p.category_id || '';
            document.getElementById('productPrice').value = p.price;
            document.getElementById('productOriginalPrice').value = p.original_price || '';
            document.getElementById('productStock').value = p.stock;
            document.getElementById('productStock').disabled = true; // ç¼–è¾‘æ—¶ä¸èƒ½ç›´æ¥æ”¹åº“å­˜
            document.getElementById('productStatus').value = p.status;
            document.getElementById('productDescription').value = p.description || '';
            document.getElementById('productSubtitle').value = p.subtitle || '';
            document.getElementById('productKeywords').value = p.keywords || '';
            document.getElementById('productRecommend').value = p.is_recommend || 0;
            document.getElementById('productNew').value = p.is_new || 0;
            document.getElementById('productHot').value = p.is_hot || 0;
            document.getElementById('coverImageUrl').value = p.cover_image || '';
            
            if (p.cover_image) {
                document.getElementById('imagePreview').innerHTML = `<img src="${p.cover_image}" alt="å°é¢" />`;
            } else {
                document.getElementById('imagePreview').innerHTML = '<span>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</span>';
            }

            document.getElementById('productModal').classList.add('show');
        }

        // å›¾ç‰‡ä¸Šä¼ 
        async function handleImageUpload() {
            const fileInput = document.getElementById('coverImageFile');
            const file = fileInput.files[0];
            if (!file) return;

            // æ˜¾ç¤ºä¸Šä¼ ä¸­
            document.getElementById('imagePreview').innerHTML = '<span>ä¸Šä¼ ä¸­...</span>';

            const result = await AdminAPI.uploadImage(file);
            if (result.success) {
                document.getElementById('coverImageUrl').value = result.data.url;
                document.getElementById('imagePreview').innerHTML = `<img src="${result.data.url}" alt="å°é¢" />`;
            } else {
                alert('ä¸Šä¼ å¤±è´¥ï¼š' + result.message);
                document.getElementById('imagePreview').innerHTML = '<span>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</span>';
            }
        }

        // éšè—å¼¹çª—
        function hideModal() {
            document.getElementById('productModal').classList.remove('show');
            document.getElementById('productStock').disabled = false;
        }

        // ä¿å­˜å•†å“
        async function saveProduct() {
            const id = document.getElementById('productId').value;
            const name = document.getElementById('productName').value.trim();
            const categoryId = document.getElementById('productCategory').value;
            const price = document.getElementById('productPrice').value;
            const originalPrice = document.getElementById('productOriginalPrice').value;
            const stock = document.getElementById('productStock').value;
            const status = document.getElementById('productStatus').value;
            const description = document.getElementById('productDescription').value.trim();
            const coverImage = document.getElementById('coverImageUrl').value;

            if (!name) {
                alert('è¯·è¾“å…¥å•†å“åç§°');
                return;
            }
            if (!price || price <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å•†å“ä»·æ ¼');
                return;
            }

            const data = {
                name: name,
                price: parseFloat(price),
                status: parseInt(status),
                description: description,
                cover_image: coverImage,
                subtitle: document.getElementById('productSubtitle').value.trim(),
                keywords: document.getElementById('productKeywords').value.trim(),
                is_recommend: parseInt(document.getElementById('productRecommend').value),
                is_new: parseInt(document.getElementById('productNew').value),
                is_hot: parseInt(document.getElementById('productHot').value)
            };

            if (categoryId) data.category_id = parseInt(categoryId);
            if (originalPrice) data.original_price = parseFloat(originalPrice);

            let result;
            if (id) {
                data.id = parseInt(id);
                result = await AdminAPI.updateProduct(data);
            } else {
                data.stock = parseInt(stock) || 0;
                result = await AdminAPI.addProduct(data);
            }

            if (result.success) {
                alert(id ? 'ä¿®æ”¹æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ');
                hideModal();
                loadProducts();
            } else {
                alert(result.message);
            }
        }

        // åˆ‡æ¢çŠ¶æ€
        async function toggleStatus(id) {
            const result = await AdminAPI.toggleProductStatus(id);
            if (result.success) {
                loadProducts();
            } else {
                alert(result.message);
            }
        }

        // åˆ é™¤å•†å“
        async function deleteProduct(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å•†å“ã€Œ${name}ã€å—ï¼Ÿ`)) {
                return;
            }

            const result = await AdminAPI.deleteProduct(id);
            if (result.success) {
                alert('åˆ é™¤æˆåŠŸ');
                loadProducts();
            } else {
                alert(result.message);
            }
        }

        // åº“å­˜ç®¡ç†
        async function manageStock(productId) {
            const result = await AdminAPI.getInventory(productId);
            if (!result.success) {
                alert('è·å–åº“å­˜ä¿¡æ¯å¤±è´¥');
                return;
            }

            const inv = result.data;
            document.getElementById('stockProductId').value = productId;
            document.getElementById('stockProductName').textContent = inv.name;
            document.getElementById('currentStock').textContent = inv.stock;
            document.getElementById('lockedStock').textContent = inv.locked_stock;
            document.getElementById('availableStock').textContent = inv.available_stock;
            document.getElementById('stockForm').reset();
            document.getElementById('stockModal').classList.add('show');
        }

        function hideStockModal() {
            document.getElementById('stockModal').classList.remove('show');
        }

        async function saveStock() {
            const productId = document.getElementById('stockProductId').value;
            const type = document.getElementById('stockType').value;
            const quantity = document.getElementById('stockQuantity').value;
            const reason = document.getElementById('stockReason').value;

            if (!quantity || quantity < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }

            const result = await AdminAPI.updateInventory(
                parseInt(productId),
                parseInt(quantity),
                type,
                reason
            );

            if (result.success) {
                alert('åº“å­˜æ›´æ–°æˆåŠŸ');
                hideStockModal();
                loadProducts();
            } else {
                alert(result.message);
            }
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            await AdminAPI.logout();
            AdminAuth.clearUser();
            window.location.href = 'login.html';
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return dateStr.substring(0, 10);
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
