<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç† - Shop åå°</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="admin-header">
        <a href="index.html" class="logo">ğŸ›’ Shop <span>åå°ç®¡ç†</span></a>
        <div class="user-info">
            <span class="username" id="adminName">ç®¡ç†å‘˜</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <aside class="admin-sidebar">
        <a href="index.html" class="menu-item">ğŸ“Š æ§åˆ¶å°</a>
        <a href="users.html" class="menu-item">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
        <a href="categories.html" class="menu-item">ğŸ·ï¸ åˆ†ç±»ç®¡ç†</a>
        <a href="brands.html" class="menu-item">ğŸ¢ å“ç‰Œç®¡ç†</a>
        <a href="attributes.html" class="menu-item">ğŸ“‹ å±æ€§ç®¡ç†</a>
        <a href="products.html" class="menu-item active">ğŸ“¦ å•†å“ç®¡ç†</a>
        <a href="orders.html" class="menu-item">ğŸ“‹ è®¢å•ç®¡ç†</a>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="admin-main">
        <div class="page-header">
            <h1>å•†å“ç®¡ç†</h1>
            <p>ç®¡ç†æ‰€æœ‰å•†å“ä¿¡æ¯ã€åº“å­˜</p>
        </div>

        <!-- æœç´¢å’Œæ“ä½œæ  -->
        <div class="toolbar">
            <div class="toolbar-left">
                <input type="text" id="searchKeyword" class="form-input" placeholder="æœç´¢å•†å“åç§°..." />
                <select id="filterCategory" class="form-select">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                </select>
                <select id="filterStatus" class="form-select">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="1">å·²ä¸Šæ¶</option>
                    <option value="0">å·²ä¸‹æ¶</option>
                </select>
                <button class="btn btn-primary" onclick="handleSearch()">æœç´¢</button>
            </div>
            <div class="toolbar-right">
                <button class="btn btn-primary" onclick="showAddModal()">+ æ·»åŠ å•†å“</button>
            </div>
        </div>

        <!-- å•†å“åˆ—è¡¨ -->
        <div class="card">
            <div class="card-body">
                <div class="loading" id="loading">åŠ è½½ä¸­...</div>
                <table class="table" id="productTable" style="display: none;">
                    <thead>
                        <tr>
                            <th width="60">ID</th>
                            <th width="80">å›¾ç‰‡</th>
                            <th>å•†å“åç§°</th>
                            <th>åˆ†ç±»</th>
                            <th width="100">ä»·æ ¼</th>
                            <th width="60">é”€é‡</th>
                            <th width="80">åº“å­˜</th>
                            <th width="80">çŠ¶æ€</th>
                            <th width="80">æ ‡ç­¾</th>
                            <th width="140">åˆ›å»ºæ—¶é—´</th>
                            <th width="200">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="productBody">
                    </tbody>
                </table>
                <div class="empty" id="emptyState" style="display: none;">æš‚æ— å•†å“æ•°æ®</div>
                
                <!-- åˆ†é¡µ -->
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ /ç¼–è¾‘å•†å“å¼¹çª— -->
    <div class="modal" id="productModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ å•†å“</h3>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId" />
                    <div class="form-row">
                        <div class="form-group">
                            <label>å•†å“åç§° <span class="required">*</span></label>
                            <input type="text" id="productName" placeholder="è¯·è¾“å…¥å•†å“åç§°" required />
                        </div>
                        <div class="form-group">
                            <label>æ‰€å±åˆ†ç±»</label>
                            <select id="productCategory">
                                <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ‰€å±å“ç‰Œ</label>
                            <select id="productBrand">
                                <option value="">è¯·é€‰æ‹©å“ç‰Œ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å‰¯æ ‡é¢˜/å–ç‚¹</label>
                        <input type="text" id="productSubtitle" placeholder="ä¸€å¥è¯æè¿°å•†å“å–ç‚¹" />
                    </div>
                    <div class="form-group">
                        <label>æœç´¢å…³é”®è¯</label>
                        <input type="text" id="productKeywords" placeholder="å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”" />
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>é”€å”®ä»·æ ¼ <span class="required">*</span></label>
                            <input type="number" id="productPrice" step="0.01" min="0" placeholder="0.00" required />
                        </div>
                        <div class="form-group">
                            <label>åŸä»·ï¼ˆåˆ’çº¿ä»·ï¼‰</label>
                            <input type="number" id="productOriginalPrice" step="0.01" min="0" placeholder="0.00" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>åˆå§‹åº“å­˜</label>
                            <input type="number" id="productStock" min="0" value="0" placeholder="0" />
                        </div>
                        <div class="form-group">
                            <label>çŠ¶æ€</label>
                            <select id="productStatus">
                                <option value="1">ä¸Šæ¶</option>
                                <option value="0">ä¸‹æ¶</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ¨è</label>
                            <select id="productRecommend">
                                <option value="0">å¦</option>
                                <option value="1">æ˜¯</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ–°å“</label>
                            <select id="productNew">
                                <option value="0">å¦</option>
                                <option value="1">æ˜¯</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>çƒ­é”€</label>
                            <select id="productHot">
                                <option value="0">å¦</option>
                                <option value="1">æ˜¯</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å°é¢å›¾ç‰‡</label>
                        <div class="image-upload">
                            <input type="file" id="coverImageFile" accept="image/*" onchange="handleImageUpload()" />
                            <input type="hidden" id="coverImageUrl" />
                            <div class="image-preview" id="imagePreview">
                                <span>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" id="productImagesGroup" style="display:none;">
                        <label>å•†å“å›¾ç‰‡ <small style="color:#999;">ï¼ˆç¼–è¾‘æ¨¡å¼å¯ç®¡ç†å¤šå¼ å›¾ç‰‡ï¼‰</small></label>
                        <div id="productImagesGallery" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;"></div>
                        <div style="margin-top:8px;">
                            <input type="file" id="galleryImageFile" accept="image/*" onchange="handleGalleryUpload()" style="display:none;" />
                            <button type="button" class="btn btn-sm" onclick="document.getElementById('galleryImageFile').click()">+ æ·»åŠ å›¾ç‰‡</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å•†å“æè¿°</label>
                        <textarea id="productDescription" rows="4" placeholder="è¯·è¾“å…¥å•†å“æè¿°"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="hideModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveProduct()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- åº“å­˜ç®¡ç†å¼¹çª— -->
    <div class="modal" id="stockModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>åº“å­˜ç®¡ç†</h3>
                <button class="modal-close" onclick="hideStockModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="stock-info">
                    <p>å•†å“ï¼š<strong id="stockProductName">-</strong></p>
                    <p>å½“å‰åº“å­˜ï¼š<strong id="currentStock">-</strong></p>
                    <p>é”å®šåº“å­˜ï¼š<strong id="lockedStock">-</strong></p>
                    <p>å¯ç”¨åº“å­˜ï¼š<strong id="availableStock">-</strong></p>
                </div>
                <hr />
                <form id="stockForm">
                    <input type="hidden" id="stockProductId" />
                    <div class="form-group">
                        <label>æ“ä½œç±»å‹</label>
                        <select id="stockType">
                            <option value="set">è®¾ç½®åº“å­˜</option>
                            <option value="add">å¢åŠ åº“å­˜</option>
                            <option value="reduce">å‡å°‘åº“å­˜</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ•°é‡ <span class="required">*</span></label>
                        <input type="number" id="stockQuantity" min="0" placeholder="è¯·è¾“å…¥æ•°é‡" required />
                    </div>
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <input type="text" id="stockReason" placeholder="æ“ä½œåŸå› ï¼ˆå¯é€‰ï¼‰" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="hideStockModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveStock()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- SKUç®¡ç†å¼¹çª— -->
    <div class="modal" id="skuModal">
        <div class="modal-content modal-large" style="max-width:900px;">
            <div class="modal-header">
                <h3 id="skuModalTitle">SKUç®¡ç†</h3>
                <button class="modal-close" onclick="hideSkuModal()">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <div id="skuContent">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="hideSkuModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <style>
        .sku-table { width:100%; border-collapse:collapse; font-size:13px; }
        .sku-table th, .sku-table td { padding:8px 10px; border:1px solid #e8e8e8; text-align:left; }
        .sku-table th { background:#fafafa; font-weight:500; }
        .sku-table input[type="number"], .sku-table input[type="text"] { width:100%; padding:4px 6px; border:1px solid #d9d9d9; border-radius:4px; font-size:13px; box-sizing:border-box; }
        .sku-add-form { background:#f9f9f9; border:1px solid #e8e8e8; border-radius:8px; padding:16px; margin-bottom:16px; }
        .sku-add-form h4 { margin:0 0 12px; font-size:14px; }
        .sku-form-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
        .sku-form-row .form-group { flex:1; min-width:120px; }
        .sku-form-row label { display:block; font-size:12px; color:#666; margin-bottom:4px; }
        .sku-form-row input, .sku-form-row select { width:100%; padding:6px 8px; border:1px solid #d9d9d9; border-radius:4px; font-size:13px; box-sizing:border-box; }
        .attr-select-group { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
        .attr-select-group label { font-size:13px; color:#333; margin-right:4px; }
        .attr-select-group select { padding:4px 8px; border:1px solid #d9d9d9; border-radius:4px; font-size:13px; }
    </style>

    <script src="js/admin-api.js"></script>
    <script>
        // çŠ¶æ€å˜é‡
        let currentPage = 1;
        const pageSize = 10;
        let categories = [];
        let brands = [];
        let editingProductId = null;

        document.addEventListener('DOMContentLoaded', async function() {
            if (!await AdminAuth.requireLoginAsync()) return;
            loadAdminInfo();
            loadCategories();
            loadBrands();
            loadProducts();

            // å›è½¦æœç´¢
            document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleSearch();
            });
        });

        function loadAdminInfo() {
            const user = AdminAuth.getUser();
            if (user) {
                document.getElementById('adminName').textContent = user.username;
            }
        }

        // åŠ è½½åˆ†ç±»
        async function loadCategories() {
            const result = await AdminAPI.getCategoryList(true, true);
            if (result.success) {
                categories = result.data;
                const filterSelect = document.getElementById('filterCategory');
                const productSelect = document.getElementById('productCategory');
                
                const sorted = [...categories].sort((a, b) => (a.path || '').localeCompare(b.path || ''));
                sorted.forEach(cat => {
                    const level = cat.level || 1;
                    let prefix = '';
                    if (level === 2) prefix = 'ã€€â”œâ”€ ';
                    if (level === 3) prefix = 'ã€€ã€€â””â”€ ';
                    const text = `${prefix}${escapeHtml(cat.name)}`;
                    filterSelect.innerHTML += `<option value="${cat.id}">${text}</option>`;
                    productSelect.innerHTML += `<option value="${cat.id}">${text}</option>`;
                });
            }
        }

        // åŠ è½½å“ç‰Œ
        async function loadBrands() {
            const result = await AdminAPI.getBrandList(true);
            if (result.success) {
                brands = result.data;
                const select = document.getElementById('productBrand');
                brands.forEach(b => {
                    select.innerHTML += `<option value="${b.id}">${escapeHtml(b.name)}${b.name_en ? ' (' + escapeHtml(b.name_en) + ')' : ''}</option>`;
                });
            }
        }

        // åŠ è½½å•†å“åˆ—è¡¨
        async function loadProducts() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('productTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            const filters = {
                page: currentPage,
                page_size: pageSize,
                keyword: document.getElementById('searchKeyword').value,
                category_id: document.getElementById('filterCategory').value,
                status: document.getElementById('filterStatus').value
            };

            const result = await AdminAPI.getProductList(filters);
            
            document.getElementById('loading').style.display = 'none';

            if (result.success) {
                if (result.data.list.length > 0) {
                    renderProducts(result.data.list);
                    renderPagination(result.data.pagination);
                    document.getElementById('productTable').style.display = 'table';
                } else {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('pagination').innerHTML = '';
                }
            } else {
                alert('åŠ è½½å¤±è´¥ï¼š' + result.message);
            }
        }

        // æ¸²æŸ“å•†å“åˆ—è¡¨
        function renderProducts(products) {
            const tbody = document.getElementById('productBody');
            tbody.innerHTML = products.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>
                        <div class="product-thumb">
                            ${p.cover_image 
                                ? `<img src="${p.cover_image}" alt="" />` 
                                : '<span class="no-image">æ— å›¾</span>'
                            }
                        </div>
                    </td>
                    <td>
                        <div class="product-name-cell">
                            <span class="product-name">${escapeHtml(p.name)}</span>
                            ${p.brand_name ? `<br><small style="color:#999;">${escapeHtml(p.brand_name)}</small>` : ''}
                        </div>
                    </td>
                    <td>${p.category_name || '-'}</td>
                    <td>
                        <span class="price">Â¥${p.price.toFixed(2)}</span>
                        ${p.original_price ? `<br><span class="original-price">Â¥${p.original_price.toFixed(2)}</span>` : ''}
                    </td>
                    <td>${p.sales_count || 0}</td>
                    <td>
                        <span class="${p.available_stock > 0 ? 'text-success' : 'text-danger'}">${p.available_stock}</span>
                        ${p.locked_stock > 0 ? `<br><small class="text-muted">é”å®š:${p.locked_stock}</small>` : ''}
                    </td>
                    <td>
                        <span class="tag ${p.status === 1 ? 'tag-success' : 'tag-danger'}">
                            ${p.status === 1 ? 'ä¸Šæ¶' : 'ä¸‹æ¶'}
                        </span>
                    </td>
                    <td>
                        ${p.is_recommend ? '<span class="tag tag-primary" style="font-size:11px">è</span>' : ''}
                        ${p.is_new ? '<span class="tag tag-success" style="font-size:11px">æ–°</span>' : ''}
                        ${p.is_hot ? '<span class="tag tag-danger" style="font-size:11px">çƒ­</span>' : ''}
                    </td>
                    <td>${formatDate(p.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editProduct(${p.id})">ç¼–è¾‘</button>
                        <button class="btn btn-sm" style="background:#722ed1;color:#fff;" onclick="manageSkus(${p.id}, '${escapeHtml(p.name)}', ${p.category_id || 0})">SKU</button>
                        <button class="btn btn-sm btn-success" onclick="manageStock(${p.id})">åº“å­˜</button>
                        <button class="btn btn-sm ${p.status === 1 ? 'btn-warning' : 'btn-success'}" onclick="toggleStatus(${p.id})">
                            ${p.status === 1 ? 'ä¸‹æ¶' : 'ä¸Šæ¶'}
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id}, '${escapeHtml(p.name)}')">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(pagination) {
            const { page, total_pages, total } = pagination;
            if (total_pages <= 1) {
                document.getElementById('pagination').innerHTML = `<span class="page-info">å…± ${total} æ¡</span>`;
                return;
            }

            let html = `<span class="page-info">å…± ${total} æ¡</span>`;
            html += `<button ${page <= 1 ? 'disabled' : ''} onclick="goToPage(${page - 1})">ä¸Šä¸€é¡µ</button>`;
            html += `<span class="page-info">ç¬¬ ${page} / ${total_pages} é¡µ</span>`;
            html += `<button ${page >= total_pages ? 'disabled' : ''} onclick="goToPage(${page + 1})">ä¸‹ä¸€é¡µ</button>`;
            
            document.getElementById('pagination').innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadProducts();
        }

        function handleSearch() {
            currentPage = 1;
            loadProducts();
        }

        // æ˜¾ç¤ºæ·»åŠ å¼¹çª—
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ å•†å“';
            document.getElementById('productId').value = '';
            document.getElementById('productForm').reset();
            document.getElementById('productStock').value = '0';
            document.getElementById('productStatus').value = '1';
            document.getElementById('productRecommend').value = '0';
            document.getElementById('productNew').value = '0';
            document.getElementById('productHot').value = '0';
            document.getElementById('productBrand').value = '';
            document.getElementById('coverImageUrl').value = '';
            document.getElementById('imagePreview').innerHTML = '<span>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</span>';
            document.getElementById('productImagesGroup').style.display = 'none';
            document.getElementById('productImagesGallery').innerHTML = '';
            editingProductId = null;
            document.getElementById('productModal').classList.add('show');
        }

        // ç¼–è¾‘å•†å“
        async function editProduct(id) {
            const result = await AdminAPI.getProductDetail(id);
            if (!result.success) {
                alert('è·å–å•†å“ä¿¡æ¯å¤±è´¥');
                return;
            }

            const p = result.data;
            editingProductId = p.id;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å•†å“';
            document.getElementById('productId').value = p.id;
            document.getElementById('productName').value = p.name;
            document.getElementById('productCategory').value = p.category_id || '';
            document.getElementById('productBrand').value = p.brand_id || '';
            document.getElementById('productPrice').value = p.price;
            document.getElementById('productOriginalPrice').value = p.original_price || '';
            document.getElementById('productStock').value = p.stock;
            document.getElementById('productStock').disabled = true;
            document.getElementById('productStatus').value = p.status;
            document.getElementById('productDescription').value = p.description || '';
            document.getElementById('productSubtitle').value = p.subtitle || '';
            document.getElementById('productKeywords').value = p.keywords || '';
            document.getElementById('productRecommend').value = p.is_recommend || 0;
            document.getElementById('productNew').value = p.is_new || 0;
            document.getElementById('productHot').value = p.is_hot || 0;
            document.getElementById('coverImageUrl').value = p.cover_image || '';
            
            if (p.cover_image) {
                document.getElementById('imagePreview').innerHTML = `<img src="${p.cover_image}" alt="å°é¢" />`;
            } else {
                document.getElementById('imagePreview').innerHTML = '<span>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</span>';
            }

            // æ˜¾ç¤ºå¹¶åŠ è½½å•†å“å›¾ç‰‡
            document.getElementById('productImagesGroup').style.display = 'block';
            loadProductImages(p.id);

            document.getElementById('productModal').classList.add('show');
        }

        // åŠ è½½å•†å“å›¾ç‰‡åˆ—è¡¨
        async function loadProductImages(productId) {
            const gallery = document.getElementById('productImagesGallery');
            gallery.innerHTML = '<span style="color:#999;">åŠ è½½ä¸­...</span>';

            const result = await AdminAPI.getProductImages(productId);
            if (!result.success) {
                gallery.innerHTML = '<span style="color:#999;">åŠ è½½å¤±è´¥</span>';
                return;
            }

            if (result.data.length === 0) {
                gallery.innerHTML = '<span style="color:#999;">æš‚æ— å›¾ç‰‡</span>';
                return;
            }

            gallery.innerHTML = result.data.map(img => `
                <div style="position:relative;width:80px;height:80px;border:2px solid ${img.is_cover ? '#1890ff' : '#eee'};border-radius:6px;overflow:hidden;">
                    <img src="${img.image_url}" style="width:100%;height:100%;object-fit:cover;" />
                    <div style="position:absolute;bottom:0;left:0;right:0;display:flex;background:rgba(0,0,0,0.5);">
                        ${!img.is_cover ? `<button onclick="setCoverImage(${img.id})" style="flex:1;border:none;background:none;color:#fff;font-size:11px;cursor:pointer;padding:2px;" title="è®¾ä¸ºå°é¢">â­</button>` : '<span style="flex:1;text-align:center;color:#ffd700;font-size:11px;padding:2px;">å°é¢</span>'}
                        <button onclick="deleteGalleryImage(${img.id})" style="flex:1;border:none;background:none;color:#ff4d4f;font-size:11px;cursor:pointer;padding:2px;" title="åˆ é™¤">âœ•</button>
                    </div>
                </div>
            `).join('');
        }

        // ä¸Šä¼ å›¾ç‰‡åˆ°å•†å“å›¾å†Œ
        async function handleGalleryUpload() {
            const file = document.getElementById('galleryImageFile').files[0];
            if (!file || !editingProductId) return;

            const uploadResult = await AdminAPI.uploadImage(file);
            if (!uploadResult.success) {
                alert('ä¸Šä¼ å¤±è´¥ï¼š' + uploadResult.message);
                return;
            }

            const addResult = await AdminAPI.addProductImage({
                product_id: editingProductId,
                image_url: uploadResult.data.url,
                sort_order: 0,
                is_cover: 0
            });

            if (addResult.success) {
                loadProductImages(editingProductId);
            } else {
                alert('æ·»åŠ å›¾ç‰‡å¤±è´¥ï¼š' + addResult.message);
            }

            document.getElementById('galleryImageFile').value = '';
        }

        // è®¾ä¸ºå°é¢å›¾
        async function setCoverImage(imageId) {
            const result = await AdminAPI.setProductImageCover(imageId);
            if (result.success) {
                loadProductImages(editingProductId);
            } else {
                alert(result.message);
            }
        }

        // åˆ é™¤å›¾å†Œå›¾ç‰‡
        async function deleteGalleryImage(imageId) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤å›¾ç‰‡ï¼Ÿ')) return;
            const result = await AdminAPI.deleteProductImage(imageId);
            if (result.success) {
                loadProductImages(editingProductId);
            } else {
                alert(result.message);
            }
        }

        // å›¾ç‰‡ä¸Šä¼ 
        async function handleImageUpload() {
            const fileInput = document.getElementById('coverImageFile');
            const file = fileInput.files[0];
            if (!file) return;

            // æ˜¾ç¤ºä¸Šä¼ ä¸­
            document.getElementById('imagePreview').innerHTML = '<span>ä¸Šä¼ ä¸­...</span>';

            const result = await AdminAPI.uploadImage(file);
            if (result.success) {
                document.getElementById('coverImageUrl').value = result.data.url;
                document.getElementById('imagePreview').innerHTML = `<img src="${result.data.url}" alt="å°é¢" />`;
            } else {
                alert('ä¸Šä¼ å¤±è´¥ï¼š' + result.message);
                document.getElementById('imagePreview').innerHTML = '<span>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</span>';
            }
        }

        // éšè—å¼¹çª—
        function hideModal() {
            document.getElementById('productModal').classList.remove('show');
            document.getElementById('productStock').disabled = false;
            editingProductId = null;
        }

        // ä¿å­˜å•†å“
        async function saveProduct() {
            const id = document.getElementById('productId').value;
            const name = document.getElementById('productName').value.trim();
            const categoryId = document.getElementById('productCategory').value;
            const price = document.getElementById('productPrice').value;
            const originalPrice = document.getElementById('productOriginalPrice').value;
            const stock = document.getElementById('productStock').value;
            const status = document.getElementById('productStatus').value;
            const description = document.getElementById('productDescription').value.trim();
            const coverImage = document.getElementById('coverImageUrl').value;

            if (!name) {
                alert('è¯·è¾“å…¥å•†å“åç§°');
                return;
            }
            if (!price || price <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å•†å“ä»·æ ¼');
                return;
            }

            const data = {
                name: name,
                price: parseFloat(price),
                status: parseInt(status),
                description: description,
                cover_image: coverImage,
                subtitle: document.getElementById('productSubtitle').value.trim(),
                keywords: document.getElementById('productKeywords').value.trim(),
                is_recommend: parseInt(document.getElementById('productRecommend').value),
                is_new: parseInt(document.getElementById('productNew').value),
                is_hot: parseInt(document.getElementById('productHot').value)
            };

            if (categoryId) data.category_id = parseInt(categoryId);
            if (originalPrice) data.original_price = parseFloat(originalPrice);

            const brandId = document.getElementById('productBrand').value;
            if (brandId) data.brand_id = parseInt(brandId);
            else data.brand_id = '';

            let result;
            if (id) {
                data.id = parseInt(id);
                result = await AdminAPI.updateProduct(data);
            } else {
                data.stock = parseInt(stock) || 0;
                result = await AdminAPI.addProduct(data);
            }

            if (result.success) {
                alert(id ? 'ä¿®æ”¹æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ');
                hideModal();
                loadProducts();
            } else {
                alert(result.message);
            }
        }

        // åˆ‡æ¢çŠ¶æ€
        async function toggleStatus(id) {
            const result = await AdminAPI.toggleProductStatus(id);
            if (result.success) {
                loadProducts();
            } else {
                alert(result.message);
            }
        }

        // åˆ é™¤å•†å“
        async function deleteProduct(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å•†å“ã€Œ${name}ã€å—ï¼Ÿ`)) {
                return;
            }

            const result = await AdminAPI.deleteProduct(id);
            if (result.success) {
                alert('åˆ é™¤æˆåŠŸ');
                loadProducts();
            } else {
                alert(result.message);
            }
        }

        // åº“å­˜ç®¡ç†
        async function manageStock(productId) {
            const result = await AdminAPI.getInventory(productId);
            if (!result.success) {
                alert('è·å–åº“å­˜ä¿¡æ¯å¤±è´¥');
                return;
            }

            const inv = result.data;
            document.getElementById('stockProductId').value = productId;
            document.getElementById('stockProductName').textContent = inv.name;
            document.getElementById('currentStock').textContent = inv.stock;
            document.getElementById('lockedStock').textContent = inv.locked_stock;
            document.getElementById('availableStock').textContent = inv.available_stock;
            document.getElementById('stockForm').reset();
            document.getElementById('stockModal').classList.add('show');
        }

        function hideStockModal() {
            document.getElementById('stockModal').classList.remove('show');
        }

        async function saveStock() {
            const productId = document.getElementById('stockProductId').value;
            const type = document.getElementById('stockType').value;
            const quantity = document.getElementById('stockQuantity').value;
            const reason = document.getElementById('stockReason').value;

            if (!quantity || quantity < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }

            const result = await AdminAPI.updateInventory(
                parseInt(productId),
                parseInt(quantity),
                type,
                reason
            );

            if (result.success) {
                alert('åº“å­˜æ›´æ–°æˆåŠŸ');
                hideStockModal();
                loadProducts();
            } else {
                alert(result.message);
            }
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            await AdminAPI.logout();
            AdminAuth.clearUser();
            window.location.href = 'login.html';
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return dateStr.substring(0, 10);
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== SKUç®¡ç† ==========
        let skuProductId = null;
        let skuCategoryId = null;
        let skuAttributes = [];
        let skuList = [];

        async function manageSkus(productId, productName, categoryId) {
            skuProductId = productId;
            skuCategoryId = categoryId;
            document.getElementById('skuModalTitle').textContent = `SKUç®¡ç† - ${productName}`;
            document.getElementById('skuModal').classList.add('show');
            
            const content = document.getElementById('skuContent');
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            // åŠ è½½å±æ€§å’ŒSKUåˆ—è¡¨
            const [attrResult, skuResult] = await Promise.all([
                categoryId ? AdminAPI.getAttributeList(categoryId) : { success: true, data: [] },
                AdminAPI.getSkuList(productId)
            ]);

            skuAttributes = attrResult.success ? attrResult.data : [];
            skuList = skuResult.success ? skuResult.data : [];

            renderSkuPanel();
        }

        function renderSkuPanel() {
            const content = document.getElementById('skuContent');

            if (skuAttributes.length === 0) {
                content.innerHTML = `
                    <div style="text-align:center;padding:30px;color:#999;">
                        <p>è¯¥å•†å“çš„åˆ†ç±»æš‚æ— è§„æ ¼å±æ€§</p>
                        <p style="margin-top:8px;">è¯·å…ˆåˆ° <a href="attributes.html" style="color:#1890ff;">å±æ€§ç®¡ç†</a> ä¸­ä¸ºè¯¥åˆ†ç±»æ·»åŠ å±æ€§ï¼ˆå¦‚é¢œè‰²ã€å°ºç ç­‰ï¼‰</p>
                    </div>
                    ${renderSkuTable()}
                `;
                return;
            }

            // æ·»åŠ SKUè¡¨å•
            let attrSelectHtml = skuAttributes.map(attr => `
                <div>
                    <label>${escapeHtml(attr.name)}ï¼š</label>
                    <select id="skuAttr_${attr.id}">
                        <option value="">è¯·é€‰æ‹©</option>
                        ${attr.values.map(v => `<option value="${v.id}" data-text="${escapeHtml(v.value)}">${escapeHtml(v.value)}</option>`).join('')}
                    </select>
                </div>
            `).join('');

            content.innerHTML = `
                <div class="sku-add-form">
                    <h4>â• æ·»åŠ SKU</h4>
                    <div class="attr-select-group">${attrSelectHtml}</div>
                    <div class="sku-form-row">
                        <div class="form-group">
                            <label>ä»·æ ¼</label>
                            <input type="number" id="skuPrice" step="0.01" min="0" placeholder="0.00" />
                        </div>
                        <div class="form-group">
                            <label>åº“å­˜</label>
                            <input type="number" id="skuStock" min="0" value="0" />
                        </div>
                        <div class="form-group">
                            <label>å°é¢å›¾URLï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" id="skuCover" placeholder="ç•™ç©ºä½¿ç”¨å•†å“ä¸»å›¾" />
                        </div>
                        <div class="form-group" style="display:flex;align-items:flex-end;">
                            <button class="btn btn-primary" onclick="addSku()">æ·»åŠ </button>
                        </div>
                    </div>
                </div>
                ${renderSkuTable()}
            `;
        }

        function renderSkuTable() {
            if (skuList.length === 0) {
                return '<div style="text-align:center;padding:20px;color:#999;">æš‚æ— SKUæ•°æ®</div>';
            }

            const rows = skuList.map(sku => {
                const attrText = sku.attr_text || (sku.attributes ? sku.attributes.map(a => `${a.attr_name}:${a.value}`).join(' / ') : '-');
                return `
                    <tr>
                        <td>${sku.id}</td>
                        <td>${escapeHtml(sku.sku_no || '-')}</td>
                        <td>${escapeHtml(attrText)}</td>
                        <td>Â¥${parseFloat(sku.price).toFixed(2)}</td>
                        <td>${sku.stock}</td>
                        <td>${sku.locked_stock || 0}</td>
                        <td>
                            <span class="tag ${sku.status == 1 ? 'tag-success' : 'tag-danger'}">${sku.status == 1 ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>
                        </td>
                        <td>
                            ${sku.cover_image ? `<img src="${sku.cover_image}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;" />` : '-'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteSku(${sku.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <table class="sku-table">
                    <thead>
                        <tr>
                            <th width="50">ID</th>
                            <th>SKUç¼–å·</th>
                            <th>è§„æ ¼</th>
                            <th width="90">ä»·æ ¼</th>
                            <th width="60">åº“å­˜</th>
                            <th width="60">é”å®š</th>
                            <th width="60">çŠ¶æ€</th>
                            <th width="60">å›¾ç‰‡</th>
                            <th width="70">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        async function addSku() {
            if (!skuProductId) return;

            const price = parseFloat(document.getElementById('skuPrice').value);
            const stock = parseInt(document.getElementById('skuStock').value) || 0;
            const cover = document.getElementById('skuCover').value.trim();

            if (!price || price <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼');
                return;
            }

            // æ”¶é›†é€‰ä¸­çš„å±æ€§å€¼
            const attrValueIds = [];
            for (const attr of skuAttributes) {
                const sel = document.getElementById(`skuAttr_${attr.id}`);
                if (sel && sel.value) {
                    attrValueIds.push(parseInt(sel.value));
                }
            }

            if (skuAttributes.length > 0 && attrValueIds.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§„æ ¼å±æ€§');
                return;
            }

            const data = {
                product_id: skuProductId,
                price: price,
                stock: stock,
                attribute_value_ids: attrValueIds
            };
            if (cover) data.cover_image = cover;

            const result = await AdminAPI.addSku(data);
            if (result.success) {
                // åˆ·æ–°SKUåˆ—è¡¨
                const skuResult = await AdminAPI.getSkuList(skuProductId);
                skuList = skuResult.success ? skuResult.data : [];
                renderSkuPanel();
            } else {
                alert(result.message);
            }
        }

        async function deleteSku(skuId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤SKUå—ï¼Ÿ')) return;
            const result = await AdminAPI.deleteSku(skuId);
            if (result.success) {
                const skuResult = await AdminAPI.getSkuList(skuProductId);
                skuList = skuResult.success ? skuResult.data : [];
                renderSkuPanel();
            } else {
                alert(result.message);
            }
        }

        function hideSkuModal() {
            document.getElementById('skuModal').classList.remove('show');
            skuProductId = null;
            skuCategoryId = null;
            skuAttributes = [];
            skuList = [];
            // åˆ·æ–°å•†å“åˆ—è¡¨ä»¥æ›´æ–°ä»·æ ¼ç­‰
            loadProducts();
        }
    </script>
</body>
</html>
