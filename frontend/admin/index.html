<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ§åˆ¶å° - Shop åå°</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="admin-header">
        <a href="index.html" class="logo">ğŸ›’ Shop <span>åå°ç®¡ç†</span></a>
        <div class="user-info">
            <span class="username" id="adminName">ç®¡ç†å‘˜</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <aside class="admin-sidebar">
        <a href="index.html" class="menu-item active">ğŸ“Š æ§åˆ¶å°</a>
        <a href="users.html" class="menu-item">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
        <a href="categories.html" class="menu-item">ğŸ·ï¸ åˆ†ç±»ç®¡ç†</a>
        <a href="products.html" class="menu-item">ğŸ“¦ å•†å“ç®¡ç†</a>
        <a href="orders.html" class="menu-item">ğŸ“‹ è®¢å•ç®¡ç†</a>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="admin-main">
        <div class="page-header">
            <h1>æ§åˆ¶å°</h1>
            <p>æ¬¢è¿å›æ¥ï¼Œè¿™æ˜¯ç³»ç»Ÿæ•°æ®æ¦‚è§ˆ</p>
        </div>

        <!-- ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ -->
        <h3 style="margin-bottom: 15px; color: #666;">ğŸ‘¥ ç”¨æˆ·ç»Ÿè®¡</h3>
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card primary">
                <div class="stat-title">ç”¨æˆ·æ€»æ•°</div>
                <div class="stat-value" id="totalUsers">-</div>
            </div>
            <div class="stat-card success">
                <div class="stat-title">æ­£å¸¸ç”¨æˆ·</div>
                <div class="stat-value" id="activeUsers">-</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-title">å·²ç¦ç”¨</div>
                <div class="stat-value" id="disabledUsers">-</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-title">ä»Šæ—¥æ–°å¢</div>
                <div class="stat-value" id="todayUsers">-</div>
            </div>
        </div>

        <!-- å•†å“ç»Ÿè®¡å¡ç‰‡ -->
        <h3 style="margin: 25px 0 15px; color: #666;">ğŸ“¦ å•†å“ç»Ÿè®¡</h3>
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-title">å•†å“æ€»æ•°</div>
                <div class="stat-value" id="totalProducts">-</div>
            </div>
            <div class="stat-card success">
                <div class="stat-title">å·²ä¸Šæ¶</div>
                <div class="stat-value" id="onlineProducts">-</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-title">å·²ä¸‹æ¶</div>
                <div class="stat-value" id="offlineProducts">-</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-title">åˆ†ç±»æ•°é‡</div>
                <div class="stat-value" id="totalCategories">-</div>
            </div>
        </div>

        <!-- æœ€è¿‘æ³¨å†Œç”¨æˆ· -->
        <div class="card" style="margin-top: 24px;">
            <div class="card-header">
                <h2>æœ€è¿‘æ³¨å†Œç”¨æˆ·</h2>
                <a href="users.html" class="btn btn-primary btn-sm">æŸ¥çœ‹å…¨éƒ¨</a>
            </div>
            <div class="card-body">
                <div class="loading" id="loadingUsers">åŠ è½½ä¸­...</div>
                <table class="table" id="usersTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>é‚®ç®±</th>
                            <th>æ‰‹æœºå·</th>
                            <th>çŠ¶æ€</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æœ€è¿‘æ·»åŠ å•†å“ -->
        <div class="card" style="margin-top: 24px;">
            <div class="card-header">
                <h2>æœ€è¿‘æ·»åŠ å•†å“</h2>
                <a href="products.html" class="btn btn-primary btn-sm">æŸ¥çœ‹å…¨éƒ¨</a>
            </div>
            <div class="card-body">
                <div class="loading" id="loadingProducts">åŠ è½½ä¸­...</div>
                <table class="table" id="productsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å•†å“åç§°</th>
                            <th>åˆ†ç±»</th>
                            <th>ä»·æ ¼</th>
                            <th>åº“å­˜</th>
                            <th>çŠ¶æ€</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="productsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="js/admin-api.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!AdminAuth.requireLogin()) {}

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminInfo();
            loadUserStats();
            loadProductStats();
            loadRecentUsers();
            loadRecentProducts();
        });

        // åŠ è½½ç®¡ç†å‘˜ä¿¡æ¯
        function loadAdminInfo() {
            const user = AdminAuth.getUser();
            if (user) {
                document.getElementById('adminName').textContent = user.username;
            }
        }

        // åŠ è½½ç”¨æˆ·ç»Ÿè®¡
        async function loadUserStats() {
            const result = await AdminAPI.getUserCount();
            
            if (result.success) {
                document.getElementById('totalUsers').textContent = result.data.total;
                document.getElementById('activeUsers').textContent = result.data.active;
                document.getElementById('disabledUsers').textContent = result.data.disabled;
                document.getElementById('todayUsers').textContent = result.data.today;
            } else {
                if (result.message.includes('ç™»å½•') || result.message.includes('æƒé™')) {
                    AdminAuth.clearUser();
                    window.location.href = 'login.html';
                }
            }
        }

        // åŠ è½½å•†å“ç»Ÿè®¡
        async function loadProductStats() {
            // è·å–å…¨éƒ¨å•†å“æ•°é‡
            const allResult = await AdminAPI.getProductList({ page: 1, page_size: 1 });
            // è·å–ä¸Šæ¶å•†å“æ•°é‡
            const onlineResult = await AdminAPI.getProductList({ page: 1, page_size: 1, status: 1 });
            // è·å–ä¸‹æ¶å•†å“æ•°é‡
            const offlineResult = await AdminAPI.getProductList({ page: 1, page_size: 1, status: 0 });
            // è·å–åˆ†ç±»æ•°é‡
            const categoryResult = await AdminAPI.getCategoryList(true, true);

            if (allResult.success) {
                document.getElementById('totalProducts').textContent = allResult.data.pagination.total;
            }
            if (onlineResult.success) {
                document.getElementById('onlineProducts').textContent = onlineResult.data.pagination.total;
            }
            if (offlineResult.success) {
                document.getElementById('offlineProducts').textContent = offlineResult.data.pagination.total;
            }
            if (categoryResult.success) {
                document.getElementById('totalCategories').textContent = categoryResult.data.length;
            }
        }

        // åŠ è½½æœ€è¿‘ç”¨æˆ·
        async function loadRecentUsers() {
            const result = await AdminAPI.getUsers(1, 5);
            
            document.getElementById('loadingUsers').style.display = 'none';
            
            if (result.success && result.data.users.length > 0) {
                document.getElementById('usersTable').style.display = 'table';
                
                const tbody = document.getElementById('usersBody');
                tbody.innerHTML = result.data.users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email || '-'}</td>
                        <td>${user.phone || '-'}</td>
                        <td>
                            <span class="tag ${user.status === 1 ? 'tag-success' : 'tag-danger'}">
                                ${user.status_name}
                            </span>
                        </td>
                        <td>${user.created_at}</td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('loadingUsers').textContent = 'æš‚æ— æ•°æ®';
                document.getElementById('loadingUsers').style.display = 'block';
            }
        }

        // åŠ è½½æœ€è¿‘å•†å“
        async function loadRecentProducts() {
            const result = await AdminAPI.getProductList({ page: 1, page_size: 5, sort_by: 'created_at', sort_order: 'DESC' });
            
            document.getElementById('loadingProducts').style.display = 'none';
            
            if (result.success && result.data.list.length > 0) {
                document.getElementById('productsTable').style.display = 'table';
                
                const tbody = document.getElementById('productsBody');
                tbody.innerHTML = result.data.list.map(p => `
                    <tr>
                        <td>${p.id}</td>
                        <td>${escapeHtml(p.name)}</td>
                        <td>${p.category_name || '-'}</td>
                        <td>Â¥${p.price.toFixed(2)}</td>
                        <td>${p.available_stock}</td>
                        <td>
                            <span class="tag ${p.status === 1 ? 'tag-success' : 'tag-danger'}">
                                ${p.status === 1 ? 'ä¸Šæ¶' : 'ä¸‹æ¶'}
                            </span>
                        </td>
                        <td>${p.created_at ? p.created_at.substring(0, 10) : '-'}</td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('loadingProducts').textContent = 'æš‚æ— æ•°æ®';
                document.getElementById('loadingProducts').style.display = 'block';
            }
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            await AdminAPI.logout();
            AdminAuth.clearUser();
            window.location.href = 'login.html';
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
