<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•ç®¡ç† - Shop åå°</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="admin-header">
        <a href="index.html" class="logo">ğŸ›’ Shop <span>åå°ç®¡ç†</span></a>
        <div class="user-info">
            <span class="username" id="adminName">ç®¡ç†å‘˜</span>
            <button class="logout-btn" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <aside class="admin-sidebar">
        <a href="index.html" class="menu-item">ğŸ“Š æ§åˆ¶å°</a>
        <a href="users.html" class="menu-item">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
        <a href="categories.html" class="menu-item">ğŸ·ï¸ åˆ†ç±»ç®¡ç†</a>
        <a href="products.html" class="menu-item">ğŸ“¦ å•†å“ç®¡ç†</a>
        <a href="orders.html" class="menu-item active">ğŸ“‹ è®¢å•ç®¡ç†</a>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="admin-main">
        <div class="page-header">
            <h1>è®¢å•ç®¡ç†</h1>
            <p>ç®¡ç†æ‰€æœ‰ç”¨æˆ·è®¢å•</p>
        </div>

        <!-- çŠ¶æ€ç»Ÿè®¡ -->
        <div class="stats-grid" id="statusStats">
            <div class="stat-card warning">
                <div class="stat-title">å¾…ä»˜æ¬¾</div>
                <div class="stat-value" id="count0">-</div>
            </div>
            <div class="stat-card primary">
                <div class="stat-title">å¾…å‘è´§</div>
                <div class="stat-value" id="count1">-</div>
            </div>
            <div class="stat-card" style="background:#fff;">
                <div class="stat-title">å¾…æ”¶è´§</div>
                <div class="stat-value" style="color:#722ed1;" id="count2">-</div>
            </div>
            <div class="stat-card success">
                <div class="stat-title">å·²å®Œæˆ</div>
                <div class="stat-value" id="count3">-</div>
            </div>
        </div>

        <!-- æœç´¢å’Œç­›é€‰ -->
        <div class="toolbar">
            <div class="toolbar-left">
                <input type="text" id="searchKeyword" class="form-input" placeholder="æœç´¢è®¢å•å·/ç”¨æˆ·å..." />
                <select id="filterStatus" class="form-select">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="0">å¾…ä»˜æ¬¾</option>
                    <option value="1">å¾…å‘è´§</option>
                    <option value="2">å¾…æ”¶è´§</option>
                    <option value="3">å·²å®Œæˆ</option>
                    <option value="4">å·²å–æ¶ˆ</option>
                    <option value="5">å·²é€€æ¬¾</option>
                </select>
                <button class="btn btn-primary" onclick="handleSearch()">æœç´¢</button>
                <button class="btn" style="background:#f5f5f5;color:#666;" onclick="resetSearch()">é‡ç½®</button>
            </div>
        </div>

        <!-- è®¢å•åˆ—è¡¨ -->
        <div class="card">
            <div class="card-body">
                <div class="loading" id="loading">åŠ è½½ä¸­...</div>
                <table class="table" id="orderTable" style="display: none;">
                    <thead>
                        <tr>
                            <th width="60">ID</th>
                            <th>è®¢å•å·</th>
                            <th>ç”¨æˆ·</th>
                            <th width="80">å•†å“æ•°</th>
                            <th width="100">é‡‘é¢</th>
                            <th width="80">çŠ¶æ€</th>
                            <th width="160">åˆ›å»ºæ—¶é—´</th>
                            <th width="180">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="orderBody"></tbody>
                </table>
                <div class="empty" id="emptyState" style="display: none;">æš‚æ— è®¢å•æ•°æ®</div>

                <div class="pagination" id="pagination" style="display: none;">
                    <button id="prevBtn" onclick="prevPage()">ä¸Šä¸€é¡µ</button>
                    <span class="page-info" id="pageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                    <button id="nextBtn" onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </main>

    <!-- è®¢å•è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="detailModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>è®¢å•è¯¦æƒ…</h3>
                <button class="modal-close" onclick="hideDetailModal()">&times;</button>
            </div>
            <div class="modal-body" id="detailContent">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script src="js/admin-api.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        const pageSize = 20;

        document.addEventListener('DOMContentLoaded', function() {
            if (!AdminAuth.requireLogin()) return;
            const user = AdminAuth.getUser();
            document.getElementById('adminName').textContent = user?.username || 'ç®¡ç†å‘˜';
            loadOrders();
        });

        async function loadOrders() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('orderTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';

            const keyword = document.getElementById('searchKeyword').value.trim();
            const status = document.getElementById('filterStatus').value;

            const params = { page: currentPage, page_size: pageSize };
            if (keyword) params.keyword = keyword;
            if (status !== '') params.status = status;

            const result = await AdminAPI.getAdminOrderList(params);

            document.getElementById('loading').style.display = 'none';

            if (!result.success) {
                document.getElementById('emptyState').textContent = result.message;
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            const { list, pagination, status_counts } = result.data;

            // æ›´æ–°çŠ¶æ€ç»Ÿè®¡
            document.getElementById('count0').textContent = status_counts[0] || 0;
            document.getElementById('count1').textContent = status_counts[1] || 0;
            document.getElementById('count2').textContent = status_counts[2] || 0;
            document.getElementById('count3').textContent = status_counts[3] || 0;

            if (list.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            totalPages = pagination.total_pages;

            const tbody = document.getElementById('orderBody');
            tbody.innerHTML = list.map(order => `
                <tr>
                    <td>${order.id}</td>
                    <td><span style="font-family:monospace;font-size:12px;">${order.order_no}</span></td>
                    <td>${escapeHtml(order.username || 'æœªçŸ¥')}</td>
                    <td>${order.item_count}</td>
                    <td class="price">Â¥${order.total_amount.toFixed(2)}</td>
                    <td><span class="tag ${getStatusTagClass(order.status)}">${order.status_text}</span></td>
                    <td>${order.created_at}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewDetail(${order.id})">è¯¦æƒ…</button>
                        ${order.status === 1 ? `<button class="btn btn-sm btn-success" onclick="shipOrder(${order.id})">å‘è´§</button>` : ''}
                        ${order.status <= 2 ? `<button class="btn btn-sm btn-warning" onclick="showStatusModal(${order.id}, ${order.status})">æ”¹çŠ¶æ€</button>` : ''}
                    </td>
                </tr>
            `).join('');

            document.getElementById('orderTable').style.display = 'table';

            if (totalPages > 1) {
                document.getElementById('pagination').style.display = 'flex';
                document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
                document.getElementById('prevBtn').disabled = currentPage <= 1;
                document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            }
        }

        function getStatusTagClass(status) {
            const map = { 0: 'tag-warning', 1: 'tag-blue', 2: 'tag-purple', 3: 'tag-success', 4: 'tag-default', 5: 'tag-danger' };
            return map[status] || '';
        }

        function handleSearch() { currentPage = 1; loadOrders(); }
        function resetSearch() {
            document.getElementById('searchKeyword').value = '';
            document.getElementById('filterStatus').value = '';
            currentPage = 1;
            loadOrders();
        }
        function prevPage() { if (currentPage > 1) { currentPage--; loadOrders(); } }
        function nextPage() { if (currentPage < totalPages) { currentPage++; loadOrders(); } }

        async function viewDetail(id) {
            document.getElementById('detailContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            document.getElementById('detailModal').classList.add('show');

            const result = await AdminAPI.getAdminOrderDetail(id);
            if (!result.success) {
                document.getElementById('detailContent').innerHTML = `<p style="color:#ff4d4f;">${result.message}</p>`;
                return;
            }

            const order = result.data;
            const addr = order.snap_address;

            document.getElementById('detailContent').innerHTML = `
                <div style="margin-bottom:20px;">
                    <div class="detail-info-grid">
                        <div class="detail-info-item"><div class="label">è®¢å•å·</div><div class="value">${order.order_no}</div></div>
                        <div class="detail-info-item"><div class="label">çŠ¶æ€</div><div class="value" style="color:${getStatusColor(order.status)};">${order.status_text}</div></div>
                        <div class="detail-info-item"><div class="label">ä¸‹å•æ—¶é—´</div><div class="value">${order.created_at}</div></div>
                        <div class="detail-info-item"><div class="label">è®¢å•é‡‘é¢</div><div class="value price">Â¥${order.total_amount.toFixed(2)}</div></div>
                    </div>
                </div>

                ${addr ? `
                <div style="background:#f6f8fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                    <h4 style="margin-bottom:8px;font-size:14px;color:#666;">ğŸ“ æ”¶è´§åœ°å€</h4>
                    <p style="font-weight:bold;">${escapeHtml(addr.name)} ${addr.phone}</p>
                    <p style="color:#666;font-size:13px;">${escapeHtml(addr.full_address || (addr.province + addr.city + addr.region + addr.detail_address))}</p>
                </div>` : ''}

                <h4 style="margin-bottom:10px;font-size:14px;color:#666;">ğŸ›ï¸ å•†å“åˆ—è¡¨</h4>
                <table class="table" style="margin-bottom:15px;">
                    <thead>
                        <tr><th>å•†å“</th><th width="80">å•ä»·</th><th width="60">æ•°é‡</th><th width="80">å°è®¡</th></tr>
                    </thead>
                    <tbody>
                        ${order.items.map(item => `
                            <tr>
                                <td>${escapeHtml(item.product_name)}</td>
                                <td>Â¥${parseFloat(item.price).toFixed(2)}</td>
                                <td>${item.quantity}</td>
                                <td class="price">Â¥${item.subtotal.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                ${order.payment ? `
                <div style="background:#f6f8fa;padding:15px;border-radius:8px;">
                    <h4 style="margin-bottom:8px;font-size:14px;color:#666;">ğŸ’³ æ”¯ä»˜ä¿¡æ¯</h4>
                    <p>äº¤æ˜“å·ï¼š${order.payment.transaction_id}</p>
                    <p>æ”¯ä»˜æ–¹å¼ï¼š${order.payment.payment_method_text || getPayMethodName(order.payment.payment_method)}</p>
                    <p>æ”¯ä»˜æ—¶é—´ï¼š${order.payment.pay_time || '-'}</p>
                </div>` : ''}

                <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end;">
                    ${order.status === 1 ? `<button class="btn btn-success" onclick="shipOrder(${order.id});hideDetailModal();">å‘è´§</button>` : ''}
                    <button class="btn" style="background:#f5f5f5;color:#666;" onclick="hideDetailModal()">å…³é—­</button>
                </div>
            `;
        }

        function getStatusColor(status) {
            const map = { 0: '#faad14', 1: '#1890ff', 2: '#722ed1', 3: '#52c41a', 4: '#999', 5: '#ff4d4f' };
            return map[status] || '#999';
        }

        function getPayMethodName(method) {
            const map = { alipay: 'æ”¯ä»˜å®', wechat: 'å¾®ä¿¡æ”¯ä»˜', balance: 'ä½™é¢æ”¯ä»˜' };
            return map[method] || method;
        }

        function hideDetailModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        async function shipOrder(id) {
            if (!confirm('ç¡®è®¤å¯¹æ­¤è®¢å•è¿›è¡Œå‘è´§ï¼Ÿ')) return;
            const result = await AdminAPI.shipOrder(id);
            if (result.success) {
                alert('å‘è´§æˆåŠŸï¼');
                loadOrders();
            } else {
                alert(result.message);
            }
        }

        function showStatusModal(id, currentStatus) {
            const statusOptions = [
                { value: 0, text: 'å¾…ä»˜æ¬¾' },
                { value: 1, text: 'å¾…å‘è´§' },
                { value: 2, text: 'å¾…æ”¶è´§' },
                { value: 3, text: 'å·²å®Œæˆ' },
                { value: 4, text: 'å·²å–æ¶ˆ' },
                { value: 5, text: 'å·²é€€æ¬¾' }
            ];

            const newStatus = prompt(
                `å½“å‰çŠ¶æ€ï¼š${statusOptions.find(s => s.value === currentStatus)?.text}\n` +
                `è¯·è¾“å…¥æ–°çŠ¶æ€ä»£ç ï¼š\n` +
                statusOptions.map(s => `${s.value} = ${s.text}`).join('\n')
            );

            if (newStatus === null) return;
            const statusInt = parseInt(newStatus);
            if (isNaN(statusInt) || statusInt < 0 || statusInt > 5) {
                alert('æ— æ•ˆçš„çŠ¶æ€ä»£ç ');
                return;
            }

            updateOrderStatus(id, statusInt);
        }

        async function updateOrderStatus(id, status) {
            const result = await AdminAPI.updateOrderStatus(id, status);
            if (result.success) {
                alert('çŠ¶æ€æ›´æ–°æˆåŠŸï¼');
                loadOrders();
            } else {
                alert(result.message);
            }
        }

        async function handleLogout() {
            await AdminAPI.logout();
            AdminAuth.clearUser();
            window.location.href = 'login.html';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
