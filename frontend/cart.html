<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­ç‰©è½¦ - Shop</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/order.css">
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸ›’ Shop</a>
        <div class="nav-links" id="navLinks"></div>
    </nav>

    <div class="page-container cart-page">
        <div class="breadcrumb">
            <a href="index.html">é¦–é¡µ</a> &gt; <span>è´­ç‰©è½¦</span>
        </div>

        <div id="cartContent">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/order-api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireLogin()) return;
            updateNavbar();
            loadCart();
        });

        function updateNavbar() {
            const navLinks = document.getElementById('navLinks');
            const user = Auth.getUser();
            navLinks.innerHTML = `
                <a href="products.html">å•†å“</a>
                <a href="cart.html">ğŸ›’ è´­ç‰©è½¦</a>
                <a href="orders.html">ğŸ“¦ è®¢å•</a>
                <a href="profile.html">ğŸ‘¤ ${user ? user.username : ''}</a>
                <a href="#" onclick="handleLogout()">é€€å‡º</a>
            `;
        }

        async function loadCart() {
            const container = document.getElementById('cartContent');
            const result = await OrderAPI.getCartList();

            if (!result.success) {
                container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ˜µ</div><p>${result.message}</p></div>`;
                return;
            }

            const data = result.data;

            if (data.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ›’</div>
                        <p>è´­ç‰©è½¦æ˜¯ç©ºçš„</p>
                        <a href="products.html" class="btn btn-primary">å»é€›é€›</a>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <div class="cart-container">
                    <div class="cart-list">
                        <div class="cart-header">
                            <label class="cart-select-all">
                                <input type="checkbox" id="selectAllCheckbox" 
                                       ${data.items.every(i => i.selected) ? 'checked' : ''}
                                       onchange="handleSelectAll(this.checked)" />
                                å…¨é€‰
                            </label>
                            <h2>è´­ç‰©è½¦ (${data.item_count}ä»¶å•†å“)</h2>
                            <button class="cart-clear-btn" onclick="handleClearCart()">ğŸ—‘ï¸ æ¸…ç©ºè´­ç‰©è½¦</button>
                        </div>
                        ${data.items.map(item => `
                            <div class="cart-item" id="cartItem_${item.id}" data-valid="${item.is_valid}">
                                <label class="cart-item-checkbox">
                                    <input type="checkbox" ${item.selected ? 'checked' : ''} 
                                           onchange="handleSelect(${item.id}, this.checked)" />
                                </label>
                                <div class="cart-item-image">
                                    ${item.cover_image
                                        ? `<img src="${item.cover_image}" alt="${escapeHtml(item.name)}" />`
                                        : '<div class="no-img">æš‚æ— å›¾ç‰‡</div>'}
                                </div>
                                <div class="cart-item-info">
                                    <h3>${escapeHtml(item.name)}</h3>
                                    <div class="cart-item-price">Â¥${item.price.toFixed(2)}</div>
                                    ${!item.is_valid ? '<div class="cart-item-status">âš ï¸ å•†å“å·²å¤±æ•ˆ</div>' : ''}
                                </div>
                                <div class="quantity-control">
                                    <button onclick="changeQty(${item.id}, ${item.quantity - 1})">âˆ’</button>
                                    <input type="number" value="${item.quantity}" min="1" max="${item.available_stock}"
                                           onchange="changeQty(${item.id}, parseInt(this.value))" />
                                    <button onclick="changeQty(${item.id}, ${item.quantity + 1})">+</button>
                                </div>
                                <div class="cart-item-subtotal">Â¥${item.subtotal.toFixed(2)}</div>
                                <button class="cart-item-delete" onclick="handleDelete(${item.id})" title="åˆ é™¤">Ã—</button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="cart-summary">
                        <h3>è®¢å•æ±‡æ€»</h3>
                        <div class="summary-row">
                            <span>å•†å“ä»¶æ•°</span>
                            <span>${data.total_quantity} ä»¶</span>
                        </div>
                        <div class="summary-row">
                            <span>è¿è´¹</span>
                            <span style="color:#52c41a;">å…è¿è´¹</span>
                        </div>
                        <div class="summary-row total">
                            <span>åˆè®¡</span>
                            <span class="amount">Â¥${data.total_amount.toFixed(2)}</span>
                        </div>
                        <button class="btn-checkout" onclick="goCheckout()" ${data.total_quantity === 0 ? 'disabled' : ''}>
                            å»ç»“ç®— (${data.total_quantity}ä»¶)
                        </button>
                    </div>
                </div>`;
        }

        async function changeQty(cartId, quantity) {
            if (quantity <= 0) {
                handleDelete(cartId);
                return;
            }
            const result = await OrderAPI.updateCartItem(cartId, quantity);
            if (result.success) {
                loadCart();
            } else {
                alert(result.message);
            }
        }

        async function handleDelete(cartId) {
            if (!confirm('ç¡®å®šä»è´­ç‰©è½¦ä¸­ç§»é™¤æ­¤å•†å“ï¼Ÿ')) return;
            const result = await OrderAPI.deleteCartItem(cartId);
            if (result.success) {
                loadCart();
            } else {
                alert(result.message);
            }
        }

        async function handleSelect(cartId, checked) {
            await OrderAPI.selectCartItem(cartId, checked ? 1 : 0);
            loadCart();
        }

        async function handleSelectAll(checked) {
            await OrderAPI.selectAllCart(checked ? 1 : 0);
            loadCart();
        }

        async function handleClearCart() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) return;
            const result = await OrderAPI.clearCart();
            if (result.success) {
                loadCart();
            } else {
                alert(result.message);
            }
        }

        function goCheckout() {
            window.location.href = 'checkout.html';
        }

        async function handleLogout() {
            await API.logout();
            Auth.clearUser();
            window.location.href = 'index.html';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
