<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“è¯¦æƒ… - Shop</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/product.css">
    <style>
        .sku-selector { margin: 15px 0; padding: 15px; background: #fafafa; border-radius: 8px; }
        .sku-selector h4 { margin: 0 0 10px; font-size: 14px; color: #333; }
        .spec-group { margin-bottom: 12px; }
        .spec-group .spec-label { font-size: 13px; color: #666; margin-bottom: 6px; }
        .spec-group .spec-values { display: flex; flex-wrap: wrap; gap: 8px; }
        .spec-btn { padding: 6px 16px; border: 1px solid #d9d9d9; border-radius: 4px; background: #fff; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .spec-btn:hover { border-color: #1890ff; color: #1890ff; }
        .spec-btn.active { border-color: #1890ff; background: #e6f7ff; color: #1890ff; font-weight: 500; }
        .spec-btn.disabled { opacity: 0.4; cursor: not-allowed; border-color: #d9d9d9; color: #999; }
        .sku-selected-info { margin-top: 10px; padding: 8px 12px; background: #fff; border-radius: 4px; font-size: 13px; color: #666; }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸ›’ Shop</a>
        <div class="nav-links" id="navLinks">
            <!-- JS åŠ¨æ€å¡«å…… -->
        </div>
    </nav>

    <div class="page-container">
        <div class="breadcrumb">
            <a href="index.html">é¦–é¡µ</a> &gt;
            <a href="products.html">å•†å“åˆ—è¡¨</a> &gt;
            <span id="breadcrumbName">å•†å“è¯¦æƒ…</span>
        </div>

        <div class="product-detail" id="productDetail">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/product-api.js"></script>
    <script src="js/order-api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            updateNavbar();
            loadProductDetail();
        });

        // æ›´æ–°å¯¼èˆªæ 
        function updateNavbar() {
            const navLinks = document.getElementById('navLinks');
            let html = '<a href="products.html">å•†å“</a>';
            
            if (Auth.isLoggedIn()) {
                const user = Auth.getUser();
                html += `
                    <a href="cart.html">ğŸ›’ è´­ç‰©è½¦</a>
                    <a href="orders.html">ğŸ“¦ è®¢å•</a>
                    <a href="favorites.html">â¤ï¸ æ”¶è—</a>
                    <a href="footprints.html">ğŸ‘£ è¶³è¿¹</a>
                    <a href="profile.html">ğŸ‘¤ ${user.username}</a>
                    <a href="#" onclick="handleLogout()">é€€å‡º</a>
                `;
            } else {
                html += `
                    <a href="login.html">ç™»å½•</a>
                    <a href="register.html">æ³¨å†Œ</a>
                `;
            }
            navLinks.innerHTML = html;
        }

        // è·å– URL å‚æ•°
        function getUrlParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // åŠ è½½å•†å“è¯¦æƒ…
        async function loadProductDetail() {
            const productId = getUrlParam('id');
            if (!productId) {
                document.getElementById('productDetail').innerHTML = 
                    '<div class="error-state">å•†å“IDæ— æ•ˆ</div>';
                return;
            }

            const result = await ProductAPI.getProductDetail(productId);

            if (result.success) {
                renderProductDetail(result.data);
            } else {
                document.getElementById('productDetail').innerHTML = 
                    `<div class="error-state">${result.message}</div>`;
            }
        }

        // æ¸²æŸ“å•†å“è¯¦æƒ…
        // å½“å‰å•†å“æ•°æ®
        let currentProduct = null;
        let currentImageIndex = 0;
        let selectedSkuId = null;
        let selectedSpecs = {};  // { attr_name: value }

        function renderProductDetail(product) {
            currentProduct = product;
            document.title = `${product.name} - Shop`;
            document.getElementById('breadcrumbName').textContent = product.name;

            const detailEl = document.getElementById('productDetail');
            
            // è®¡ç®—æŠ˜æ‰£
            let discountHtml = '';
            if (product.original_price && product.original_price > product.price) {
                const discount = Math.round((1 - product.price / product.original_price) * 100);
                discountHtml = `<span class="discount-tag">çœ ${discount}%</span>`;
            }

            // åº“å­˜çŠ¶æ€
            const stockStatus = product.available_stock > 0 
                ? `<span class="stock-available">æœ‰è´§ (${product.available_stock}ä»¶)</span>`
                : '<span class="stock-out">æš‚æ—¶ç¼ºè´§</span>';

            // æ„å»ºå›¾ç‰‡åˆ—è¡¨ï¼ˆå°é¢ + å•†å“å›¾å†Œï¼‰
            const allImages = [];
            if (product.cover_image) allImages.push(product.cover_image);
            if (product.images && product.images.length > 0) {
                product.images.forEach(img => {
                    if (img.image_url && !allImages.includes(img.image_url)) {
                        allImages.push(img.image_url);
                    }
                });
            }

            const imageGalleryHtml = allImages.length > 0 ? `
                <div class="detail-image-main">
                    <img id="mainImage" src="${allImages[0]}" alt="${escapeHtml(product.name)}" />
                </div>
                ${allImages.length > 1 ? `
                <div class="detail-image-thumbs">
                    ${allImages.map((img, i) => `
                        <img src="${img}" class="thumb-img ${i === 0 ? 'active' : ''}" onclick="switchImage(${i}, '${img}')" />
                    `).join('')}
                </div>` : ''}
            ` : '<div class="no-image-large">æš‚æ— å›¾ç‰‡</div>';

            detailEl.innerHTML = `
                <div class="detail-main">
                    <div class="detail-image">
                        ${imageGalleryHtml}
                    </div>
                    <div class="detail-info">
                        <h1 class="detail-name">
                            ${product.is_recommend ? '<span class="product-tag tag-recommend">æ¨è</span>' : ''}
                            ${product.is_new ? '<span class="product-tag tag-new">æ–°å“</span>' : ''}
                            ${product.is_hot ? '<span class="product-tag tag-hot">çƒ­é”€</span>' : ''}
                            ${escapeHtml(product.name)}
                        </h1>
                        ${product.subtitle ? `<p class="detail-subtitle">${escapeHtml(product.subtitle)}</p>` : ''}
                        <p class="detail-category">
                            åˆ†ç±»ï¼š${product.category_name || 'æœªåˆ†ç±»'}
                            ${product.brand_name ? ` | å“ç‰Œï¼š<strong>${escapeHtml(product.brand_name)}</strong>` : ''}
                        </p>
                        
                        <div class="detail-price-section">
                            <div class="detail-price">
                                <span class="price-label">ä»·æ ¼</span>
                                <span class="price-current">Â¥${product.price.toFixed(2)}</span>
                                ${product.original_price 
                                    ? `<span class="price-original">Â¥${product.original_price.toFixed(2)}</span>` 
                                    : ''
                                }
                                ${discountHtml}
                            </div>
                        </div>

                        <div class="detail-stats">
                            <span>â­ ${product.avg_rating || product.rating || '5.0'}åˆ† (${product.total_reviews || 0}æ¡è¯„ä»·)</span>
                            <span>ğŸ“¦ å·²å”® ${product.sales_count || 0}</span>
                            <span>ğŸ‘€ ${product.view_count || 0}æ¬¡æµè§ˆ</span>
                        </div>

                        <div class="detail-stock">
                            <span class="stock-label">åº“å­˜çŠ¶æ€</span>
                            <span id="stockStatusText">${stockStatus}</span>
                        </div>

                        ${product.spec_list && product.spec_list.length > 0 ? `
                        <div class="sku-selector" id="skuSelector">
                            <h4>é€‰æ‹©è§„æ ¼</h4>
                            ${product.spec_list.map(spec => `
                                <div class="spec-group">
                                    <div class="spec-label">${escapeHtml(spec.name)}ï¼š</div>
                                    <div class="spec-values">
                                        ${spec.values.map(v => `
                                            <button class="spec-btn" data-attr="${escapeHtml(spec.name)}" data-value="${escapeHtml(v.value)}" onclick="selectSpec(this, '${escapeHtml(spec.name)}', '${escapeHtml(v.value)}')">${escapeHtml(v.value)}</button>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                            <div class="sku-selected-info" id="skuSelectedInfo">è¯·é€‰æ‹©è§„æ ¼</div>
                        </div>
                        ` : ''}

                        <div class="detail-actions">
                            <div class="quantity-selector">
                                <button class="qty-btn" onclick="changeQty(-1)">-</button>
                                <input type="number" id="quantity" value="1" min="1" max="${product.available_stock}" />
                                <button class="qty-btn" onclick="changeQty(1)">+</button>
                            </div>
                            <button class="btn btn-primary btn-add-cart" id="addCartBtn"
                                    onclick="addToCart(${product.id})"
                                    ${product.available_stock <= 0 ? 'disabled' : ''}>
                                ${product.available_stock > 0 ? 'åŠ å…¥è´­ç‰©è½¦' : 'æš‚æ—¶ç¼ºè´§'}
                            </button>
                            <button class="btn btn-buy-now" id="buyNowBtn"
                                    onclick="buyNow(${product.id})"
                                    ${product.available_stock <= 0 ? 'disabled' : ''}
                                    style="background:#ff4400;color:#fff;border:none;padding:12px 30px;border-radius:4px;font-size:15px;cursor:pointer;margin-left:10px;">
                                ${product.available_stock > 0 ? 'ç«‹å³è´­ä¹°' : 'æš‚æ—¶ç¼ºè´§'}
                            </button>
                            <button class="btn btn-favorite ${product.is_favorited ? 'favorited' : ''}" 
                                    id="favoriteBtn"
                                    onclick="toggleFavorite(${product.id})">
                                ${product.is_favorited ? 'â¤ï¸ å·²æ”¶è—' : 'ğŸ¤ æ”¶è—'}
                            </button>
                        </div>

                        <div class="detail-meta">
                            ${product.spu_no ? `<p>å•†å“ç¼–å·ï¼š${escapeHtml(product.spu_no)}</p>` : `<p>å•†å“IDï¼š${product.id}</p>`}
                            <p>ä¸Šæ¶æ—¶é—´ï¼š${formatDate(product.created_at)}</p>
                        </div>
                    </div>
                </div>

                <div class="detail-tabs">
                    <div class="tab-nav">
                        <button class="tab-btn active" onclick="switchTab('desc')">å•†å“è¯¦æƒ…</button>
                        <button class="tab-btn" onclick="switchTab('reviews')">å•†å“è¯„ä»· (${product.total_reviews || 0})</button>
                    </div>
                    <div class="tab-content" id="tabDesc">
                        <div class="description-content">
                            ${product.description 
                                ? escapeHtml(product.description).replace(/\n/g, '<br>')
                                : '<p class="no-description">æš‚æ— å•†å“è¯¦æƒ…</p>'
                            }
                        </div>
                    </div>
                    <div class="tab-content" id="tabReviews" style="display:none;">
                        <div id="reviewsContent"><div class="loading">åŠ è½½è¯„ä»·ä¸­...</div></div>
                    </div>
                </div>
            `;

            // åŠ è½½è¯„ä»·
            loadReviews(product.id);
        }

        // åˆ‡æ¢ä¸»å›¾
        function switchImage(index, url) {
            currentImageIndex = index;
            document.getElementById('mainImage').src = url;
            document.querySelectorAll('.thumb-img').forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tabDesc').style.display = tab === 'desc' ? 'block' : 'none';
            document.getElementById('tabReviews').style.display = tab === 'reviews' ? 'block' : 'none';
            event.target.classList.add('active');
        }

        // åŠ è½½è¯„ä»·
        async function loadReviews(productId) {
            const result = await ProductAPI.getReviewList(productId, 1, 20);
            const container = document.getElementById('reviewsContent');

            if (!result.success) {
                container.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">åŠ è½½è¯„ä»·å¤±è´¥</p>';
                return;
            }

            const { list, stats } = result.data;

            let html = `
                <div class="review-stats">
                    <div class="review-score">${stats.avg_rating}</div>
                    <div class="review-summary">
                        <div>å¥½è¯„ç‡ ${stats.good_rate}%</div>
                        <div style="color:#999;font-size:13px;">
                            å¥½è¯„(${stats.good_count}) ä¸­è¯„(${stats.mid_count}) å·®è¯„(${stats.bad_count})
                        </div>
                    </div>
                </div>
            `;

            if (list.length === 0) {
                html += '<p style="color:#999;text-align:center;padding:30px;">æš‚æ— è¯„ä»·</p>';
            } else {
                html += list.map(r => `
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-user">ğŸ‘¤ ${escapeHtml(r.username || 'åŒ¿åç”¨æˆ·')}</span>
                            <span class="review-rating">${'â­'.repeat(r.rating)}</span>
                            <span class="review-time">${r.created_at ? r.created_at.substring(0, 10) : ''}</span>
                        </div>
                        <div class="review-body">${r.content ? escapeHtml(r.content) : '<span style="color:#999;">ç”¨æˆ·æœªå¡«å†™è¯„ä»·å†…å®¹</span>'}</div>
                        ${r.images && r.images.length > 0 ? `
                            <div class="review-images">
                                ${r.images.map(img => `<img src="${img}" class="review-img" />`).join('')}
                            </div>
                        ` : ''}
                        ${r.reply_content ? `
                            <div class="review-reply">
                                <strong>å•†å®¶å›å¤ï¼š</strong>${escapeHtml(r.reply_content)}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }

            container.innerHTML = html;
        }

        // æ”¶è—/å–æ¶ˆæ”¶è—
        async function toggleFavorite(productId) {
            if (!Auth.isLoggedIn()) {
                if (confirm('è¯·å…ˆç™»å½•åå†æ”¶è—ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ')) {
                    window.location.href = 'login.html';
                }
                return;
            }

            const btn = document.getElementById('favoriteBtn');
            const isFavorited = btn.classList.contains('favorited');

            let result;
            if (isFavorited) {
                result = await API.deleteFavorite(productId);
                if (result.success) {
                    btn.classList.remove('favorited');
                    btn.innerHTML = 'ğŸ¤ æ”¶è—';
                }
            } else {
                result = await API.addFavorite(productId);
                if (result.success) {
                    btn.classList.add('favorited');
                    btn.innerHTML = 'â¤ï¸ å·²æ”¶è—';
                }
            }

            if (!result.success) alert(result.message);
        }

        // æ•°é‡è°ƒæ•´
        function changeQty(delta) {
            const input = document.getElementById('quantity');
            const max = parseInt(input.max) || 999;
            let value = parseInt(input.value) || 1;
            value += delta;
            if (value < 1) value = 1;
            if (value > max) value = max;
            input.value = value;
        }

        // åŠ å…¥è´­ç‰©è½¦
        async function addToCart(productId) {
            if (!Auth.isLoggedIn()) {
                if (confirm('è¯·å…ˆç™»å½•åå†æ·»åŠ è´­ç‰©è½¦ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ')) {
                    window.location.href = 'login.html';
                }
                return;
            }

            // å¦‚æœæœ‰SKUè§„æ ¼ï¼Œå¿…é¡»å…ˆé€‰æ‹©
            if (currentProduct && currentProduct.spec_list && currentProduct.spec_list.length > 0 && !selectedSkuId) {
                alert('è¯·å…ˆé€‰æ‹©å•†å“è§„æ ¼');
                return;
            }
            
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const result = await OrderAPI.addToCart(productId, quantity, selectedSkuId);
            if (result.success) {
                if (confirm('âœ… å·²åŠ å…¥è´­ç‰©è½¦ï¼\n\nå»è´­ç‰©è½¦æŸ¥çœ‹ï¼Ÿ')) {
                    window.location.href = 'cart.html';
                }
            } else {
                alert(result.message);
            }
        }

        // ç«‹å³è´­ä¹°
        function buyNow(productId) {
            if (!Auth.isLoggedIn()) {
                if (confirm('è¯·å…ˆç™»å½•åå†è´­ä¹°ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ')) {
                    window.location.href = 'login.html';
                }
                return;
            }

            // å¦‚æœæœ‰SKUè§„æ ¼ï¼Œå¿…é¡»å…ˆé€‰æ‹©
            if (currentProduct && currentProduct.spec_list && currentProduct.spec_list.length > 0 && !selectedSkuId) {
                alert('è¯·å…ˆé€‰æ‹©å•†å“è§„æ ¼');
                return;
            }

            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            let url = `checkout.html?mode=direct&product_id=${productId}&quantity=${quantity}`;
            if (selectedSkuId) {
                url += `&sku_id=${selectedSkuId}`;
            }
            window.location.href = url;
        }

        // SKUè§„æ ¼é€‰æ‹©
        function selectSpec(btn, attrName, value) {
            // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
            const group = btn.parentElement;
            const wasActive = btn.classList.contains('active');
            group.querySelectorAll('.spec-btn').forEach(b => b.classList.remove('active'));
            
            if (!wasActive) {
                btn.classList.add('active');
                selectedSpecs[attrName] = value;
            } else {
                delete selectedSpecs[attrName];
            }

            matchSku();
        }

        function matchSku() {
            selectedSkuId = null;
            const infoEl = document.getElementById('skuSelectedInfo');
            const cartBtn = document.getElementById('addCartBtn');
            const buyBtn = document.getElementById('buyNowBtn');
            const stockEl = document.getElementById('stockStatusText');
            const qtyInput = document.getElementById('quantity');

            if (!currentProduct || !currentProduct.skus) return;

            const specCount = currentProduct.spec_list ? currentProduct.spec_list.length : 0;
            const selectedCount = Object.keys(selectedSpecs).length;

            if (selectedCount === 0) {
                infoEl.textContent = 'è¯·é€‰æ‹©è§„æ ¼';
                // æ¢å¤SPUé»˜è®¤
                stockEl.innerHTML = currentProduct.available_stock > 0 
                    ? `<span class="stock-available">æœ‰è´§ (${currentProduct.available_stock}ä»¶)</span>` 
                    : '<span class="stock-out">æš‚æ—¶ç¼ºè´§</span>';
                cartBtn.disabled = currentProduct.available_stock <= 0;
                cartBtn.textContent = currentProduct.available_stock > 0 ? 'åŠ å…¥è´­ç‰©è½¦' : 'æš‚æ—¶ç¼ºè´§';
                if (buyBtn) {
                    buyBtn.disabled = currentProduct.available_stock <= 0;
                    buyBtn.textContent = currentProduct.available_stock > 0 ? 'ç«‹å³è´­ä¹°' : 'æš‚æ—¶ç¼ºè´§';
                }
                qtyInput.max = currentProduct.available_stock;
                return;
            }

            // å°è¯•åŒ¹é…SKU
            const selectedText = Object.entries(selectedSpecs).map(([k, v]) => `${k}:${v}`).join(' / ');
            infoEl.textContent = 'å·²é€‰ï¼š' + selectedText;

            // ç²¾ç¡®åŒ¹é…ï¼šæ‰¾åˆ°åŒ…å«æ‰€æœ‰é€‰ä¸­å±æ€§å€¼çš„SKU
            const matchedSku = currentProduct.skus.find(sku => {
                if (!sku.attributes) return false;
                return Object.entries(selectedSpecs).every(([attrName, value]) => {
                    return sku.attributes.some(a => a.attribute_name === attrName && a.attribute_value === value);
                }) && sku.attributes.length === selectedCount;
            });

            if (matchedSku && selectedCount === specCount) {
                selectedSkuId = matchedSku.id;
                const skuAvailable = matchedSku.stock - (matchedSku.locked_stock || 0);
                const skuPrice = parseFloat(matchedSku.price);

                // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
                const priceEl = document.querySelector('.price-current');
                if (priceEl) priceEl.textContent = 'Â¥' + skuPrice.toFixed(2);

                // æ›´æ–°åº“å­˜æ˜¾ç¤º
                stockEl.innerHTML = skuAvailable > 0 
                    ? `<span class="stock-available">æœ‰è´§ (${skuAvailable}ä»¶)</span>` 
                    : '<span class="stock-out">æš‚æ—¶ç¼ºè´§</span>';

                // æ›´æ–°ä¸»å›¾
                if (matchedSku.cover_image) {
                    const mainImg = document.getElementById('mainImage');
                    if (mainImg) mainImg.src = matchedSku.cover_image;
                }

                cartBtn.disabled = skuAvailable <= 0;
                cartBtn.textContent = skuAvailable > 0 ? 'åŠ å…¥è´­ç‰©è½¦' : 'æš‚æ—¶ç¼ºè´§';
                if (buyBtn) {
                    buyBtn.disabled = skuAvailable <= 0;
                    buyBtn.textContent = skuAvailable > 0 ? 'ç«‹å³è´­ä¹°' : 'æš‚æ—¶ç¼ºè´§';
                }
                qtyInput.max = skuAvailable;
                if (parseInt(qtyInput.value) > skuAvailable) qtyInput.value = Math.max(1, skuAvailable);
                
                infoEl.textContent = `å·²é€‰ï¼š${selectedText} | ä»·æ ¼ï¼šÂ¥${skuPrice.toFixed(2)} | åº“å­˜ï¼š${skuAvailable}`;
            } else if (selectedCount < specCount) {
                infoEl.textContent = `å·²é€‰ï¼š${selectedText}ï¼ˆè¯·ç»§ç»­é€‰æ‹©å…¶ä»–è§„æ ¼ï¼‰`;
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            await API.logout();
            Auth.clearUser();
            window.location.reload();
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
