<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“è¯¦æƒ… - Shop</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/product.css">
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸ›’ Shop</a>
        <div class="nav-links" id="navLinks">
            <!-- JS åŠ¨æ€å¡«å…… -->
        </div>
    </nav>

    <div class="page-container">
        <div class="breadcrumb">
            <a href="index.html">é¦–é¡µ</a> &gt;
            <a href="products.html">å•†å“åˆ—è¡¨</a> &gt;
            <span id="breadcrumbName">å•†å“è¯¦æƒ…</span>
        </div>

        <div class="product-detail" id="productDetail">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/product-api.js"></script>
    <script src="js/order-api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            updateNavbar();
            loadProductDetail();
        });

        // æ›´æ–°å¯¼èˆªæ 
        function updateNavbar() {
            const navLinks = document.getElementById('navLinks');
            let html = '<a href="products.html">å•†å“</a>';
            
            if (Auth.isLoggedIn()) {
                const user = Auth.getUser();
                html += `
                    <a href="cart.html">ğŸ›’ è´­ç‰©è½¦</a>
                    <a href="orders.html">ğŸ“¦ è®¢å•</a>
                    <a href="profile.html">ğŸ‘¤ ${user.username}</a>
                    <a href="#" onclick="handleLogout()">é€€å‡º</a>
                `;
            } else {
                html += `
                    <a href="login.html">ç™»å½•</a>
                    <a href="register.html">æ³¨å†Œ</a>
                `;
            }
            navLinks.innerHTML = html;
        }

        // è·å– URL å‚æ•°
        function getUrlParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // åŠ è½½å•†å“è¯¦æƒ…
        async function loadProductDetail() {
            const productId = getUrlParam('id');
            if (!productId) {
                document.getElementById('productDetail').innerHTML = 
                    '<div class="error-state">å•†å“IDæ— æ•ˆ</div>';
                return;
            }

            const result = await ProductAPI.getProductDetail(productId);

            if (result.success) {
                renderProductDetail(result.data);
            } else {
                document.getElementById('productDetail').innerHTML = 
                    `<div class="error-state">${result.message}</div>`;
            }
        }

        // æ¸²æŸ“å•†å“è¯¦æƒ…
        function renderProductDetail(product) {
            document.title = `${product.name} - Shop`;
            document.getElementById('breadcrumbName').textContent = product.name;

            const detailEl = document.getElementById('productDetail');
            
            // è®¡ç®—æŠ˜æ‰£
            let discountHtml = '';
            if (product.original_price && product.original_price > product.price) {
                const discount = Math.round((1 - product.price / product.original_price) * 100);
                discountHtml = `<span class="discount-tag">çœ ${discount}%</span>`;
            }

            // åº“å­˜çŠ¶æ€
            const stockStatus = product.available_stock > 0 
                ? `<span class="stock-available">æœ‰è´§ (${product.available_stock}ä»¶)</span>`
                : '<span class="stock-out">æš‚æ—¶ç¼ºè´§</span>';

            detailEl.innerHTML = `
                <div class="detail-main">
                    <div class="detail-image">
                        ${product.cover_image 
                            ? `<img src="${product.cover_image}" alt="${escapeHtml(product.name)}" />`
                            : '<div class="no-image-large">æš‚æ— å›¾ç‰‡</div>'
                        }
                    </div>
                    <div class="detail-info">
                        <h1 class="detail-name">
                            ${product.is_recommend ? '<span class="product-tag tag-recommend">æ¨è</span>' : ''}
                            ${product.is_new ? '<span class="product-tag tag-new">æ–°å“</span>' : ''}
                            ${product.is_hot ? '<span class="product-tag tag-hot">çƒ­é”€</span>' : ''}
                            ${escapeHtml(product.name)}
                        </h1>
                        ${product.subtitle ? `<p class="detail-subtitle">${escapeHtml(product.subtitle)}</p>` : ''}
                        <p class="detail-category">åˆ†ç±»ï¼š${product.category_name || 'æœªåˆ†ç±»'}</p>
                        
                        <div class="detail-price-section">
                            <div class="detail-price">
                                <span class="price-label">ä»·æ ¼</span>
                                <span class="price-current">Â¥${product.price.toFixed(2)}</span>
                                ${product.original_price 
                                    ? `<span class="price-original">Â¥${product.original_price.toFixed(2)}</span>` 
                                    : ''
                                }
                                ${discountHtml}
                            </div>
                        </div>

                        <div class="detail-stats">
                            <span>â­ ${product.rating || '5.0'}åˆ†</span>
                            <span>ğŸ“¦ å·²å”® ${product.sales_count || 0}</span>
                            <span>ğŸ‘€ ${product.view_count || 0}æ¬¡æµè§ˆ</span>
                        </div>

                        <div class="detail-stock">
                            <span class="stock-label">åº“å­˜çŠ¶æ€</span>
                            ${stockStatus}
                        </div>

                        <div class="detail-actions">
                            <div class="quantity-selector">
                                <button class="qty-btn" onclick="changeQty(-1)">-</button>
                                <input type="number" id="quantity" value="1" min="1" max="${product.available_stock}" />
                                <button class="qty-btn" onclick="changeQty(1)">+</button>
                            </div>
                            <button class="btn btn-primary btn-add-cart" 
                                    onclick="addToCart(${product.id})"
                                    ${product.available_stock <= 0 ? 'disabled' : ''}>
                                ${product.available_stock > 0 ? 'åŠ å…¥è´­ç‰©è½¦' : 'æš‚æ—¶ç¼ºè´§'}
                            </button>
                        </div>

                        <div class="detail-meta">
                            ${product.spu_no ? `<p>å•†å“ç¼–å·ï¼š${escapeHtml(product.spu_no)}</p>` : `<p>å•†å“IDï¼š${product.id}</p>`}
                            <p>ä¸Šæ¶æ—¶é—´ï¼š${formatDate(product.created_at)}</p>
                        </div>
                    </div>
                </div>

                <div class="detail-description">
                    <h2>å•†å“è¯¦æƒ…</h2>
                    <div class="description-content">
                        ${product.description 
                            ? escapeHtml(product.description).replace(/\n/g, '<br>')
                            : '<p class="no-description">æš‚æ— å•†å“è¯¦æƒ…</p>'
                        }
                    </div>
                </div>
            `;
        }

        // æ•°é‡è°ƒæ•´
        function changeQty(delta) {
            const input = document.getElementById('quantity');
            const max = parseInt(input.max) || 999;
            let value = parseInt(input.value) || 1;
            value += delta;
            if (value < 1) value = 1;
            if (value > max) value = max;
            input.value = value;
        }

        // åŠ å…¥è´­ç‰©è½¦
        async function addToCart(productId) {
            if (!Auth.isLoggedIn()) {
                if (confirm('è¯·å…ˆç™»å½•åå†æ·»åŠ è´­ç‰©è½¦ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ')) {
                    window.location.href = 'login.html';
                }
                return;
            }
            
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const result = await OrderAPI.addToCart(productId, quantity);
            if (result.success) {
                if (confirm('âœ… å·²åŠ å…¥è´­ç‰©è½¦ï¼\n\nå»è´­ç‰©è½¦æŸ¥çœ‹ï¼Ÿ')) {
                    window.location.href = 'cart.html';
                }
            } else {
                alert(result.message);
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            await API.logout();
            Auth.clearUser();
            window.location.reload();
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
