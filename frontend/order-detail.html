<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•è¯¦æƒ… - Shop</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/order.css">
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸ›’ Shop</a>
        <div class="nav-links" id="navLinks"></div>
    </nav>

    <div class="page-container">
        <div class="breadcrumb">
            <a href="index.html">é¦–é¡µ</a> &gt;
            <a href="orders.html">æˆ‘çš„è®¢å•</a> &gt;
            <span>è®¢å•è¯¦æƒ…</span>
        </div>

        <div id="orderDetailContent">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- æ”¯ä»˜å¼¹çª— -->
    <div id="payModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:#fff;border-radius:12px;width:90%;max-width:450px;box-shadow:0 4px 20px rgba(0,0,0,0.15);">
            <div style="padding:20px 24px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;">
                <h3 style="margin:0;font-size:18px;color:#333;">ğŸ’³ è®¢å•æ”¯ä»˜</h3>
                <button onclick="hidePayModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#999;">&times;</button>
            </div>
            <div style="padding:24px;">
                <div style="text-align:center;margin-bottom:25px;">
                    <p style="color:#666;font-size:14px;">æ”¯ä»˜é‡‘é¢</p>
                    <p style="font-size:36px;font-weight:bold;color:#e4393c;margin:10px 0;" id="payAmount">Â¥0.00</p>
                </div>

                <p style="font-size:14px;color:#333;margin-bottom:12px;font-weight:500;">é€‰æ‹©æ”¯ä»˜æ–¹å¼</p>
                <div class="payment-methods" id="paymentMethods">
                    <div class="payment-method selected" onclick="selectPayment(this, 'alipay')">
                        <span class="pay-icon">ğŸ’³</span>
                        <span class="pay-name">æ”¯ä»˜å®</span>
                    </div>
                    <div class="payment-method" onclick="selectPayment(this, 'wechat')">
                        <span class="pay-icon">ğŸ’š</span>
                        <span class="pay-name">å¾®ä¿¡æ”¯ä»˜</span>
                    </div>
                    <div class="payment-method" onclick="selectPayment(this, 'balance')">
                        <span class="pay-icon">ğŸ’°</span>
                        <span class="pay-name">ä½™é¢æ”¯ä»˜</span>
                    </div>
                </div>

                <button onclick="confirmPay()" style="width:100%;padding:14px;background:linear-gradient(135deg,#e4393c,#ff6b6b);color:#fff;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;margin-top:10px;">
                    ç¡®è®¤æ”¯ä»˜
                </button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/order-api.js"></script>
    <script>
        let orderId = 0;
        let orderData = null;
        let selectedPayment = 'alipay';

        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireLogin()) return;
            updateNavbar();

            const params = new URLSearchParams(window.location.search);
            orderId = parseInt(params.get('id'));

            if (!orderId) {
                document.getElementById('orderDetailContent').innerHTML =
                    '<div class="empty-state"><div class="empty-icon">âŒ</div><p>è®¢å•ä¸å­˜åœ¨</p></div>';
                return;
            }

            loadOrderDetail();
        });

        function updateNavbar() {
            const navLinks = document.getElementById('navLinks');
            const user = Auth.getUser();
            navLinks.innerHTML = `
                <a href="products.html">å•†å“</a>
                <a href="cart.html">ğŸ›’ è´­ç‰©è½¦</a>
                <a href="orders.html">ğŸ“¦ è®¢å•</a>
                <a href="profile.html">ğŸ‘¤ ${user ? user.username : ''}</a>
                <a href="#" onclick="handleLogout()">é€€å‡º</a>
            `;
        }

        async function loadOrderDetail() {
            const container = document.getElementById('orderDetailContent');
            const result = await OrderAPI.getOrderDetail(orderId);

            if (!result.success) {
                container.innerHTML = `<div class="empty-state"><div class="empty-icon">âŒ</div><p>${result.message}</p></div>`;
                return;
            }

            orderData = result.data;
            const order = orderData;
            const addr = order.snap_address;

            container.innerHTML = `
                <!-- è®¢å•çŠ¶æ€ -->
                <div class="detail-section" style="background:linear-gradient(135deg,${getStatusGradient(order.status)});color:#fff;border-radius:12px;">
                    <div style="padding:30px;">
                        <div style="font-size:24px;font-weight:bold;margin-bottom:8px;">${order.status_text}</div>
                        <div style="opacity:0.9;font-size:14px;">${getStatusDescription(order.status)}</div>
                        <div style="margin-top:20px;display:flex;gap:10px;">
                            ${getDetailActions(order)}
                        </div>
                    </div>
                </div>

                <!-- è®¢å•ä¿¡æ¯ -->
                <div class="detail-section">
                    <div class="detail-section-header">ğŸ“‹ è®¢å•ä¿¡æ¯</div>
                    <div class="detail-section-body">
                        <div class="detail-info-grid">
                            <div class="detail-info-item">
                                <div class="label">è®¢å•å·</div>
                                <div class="value">${order.order_no}</div>
                            </div>
                            <div class="detail-info-item">
                                <div class="label">åˆ›å»ºæ—¶é—´</div>
                                <div class="value">${order.created_at}</div>
                            </div>
                            <div class="detail-info-item">
                                <div class="label">è®¢å•çŠ¶æ€</div>
                                <div class="value" style="color:${getStatusColor(order.status)};">${order.status_text}</div>
                            </div>
                            <div class="detail-info-item">
                                <div class="label">è®¢å•é‡‘é¢</div>
                                <div class="value" style="color:#e4393c;font-size:18px;">Â¥${order.total_amount.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ”¶è´§åœ°å€ -->
                ${addr ? `
                <div class="detail-section">
                    <div class="detail-section-header">ğŸ“ æ”¶è´§åœ°å€</div>
                    <div class="detail-section-body">
                        <p style="font-weight:bold;margin-bottom:5px;">${escapeHtml(addr.name)} ${addr.phone}</p>
                        <p style="color:#666;">${escapeHtml(addr.full_address || (addr.province + addr.city + addr.region + addr.detail_address))}</p>
                    </div>
                </div>` : ''}

                <!-- å•†å“æ¸…å• -->
                <div class="detail-section">
                    <div class="detail-section-header">ğŸ›ï¸ å•†å“æ¸…å•</div>
                    <div class="detail-section-body">
                        ${order.items.map(item => `
                            <div class="order-product">
                                <div class="order-product-img">
                                    ${item.cover_image ? `<img src="${item.cover_image}" />` : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:11px;">æ— å›¾</div>'}
                                </div>
                                <div class="order-product-info">
                                    <h4>${escapeHtml(item.product_name)}</h4>
                                    <div class="product-price-qty">Â¥${parseFloat(item.price).toFixed(2)} Ã— ${item.quantity}</div>
                                </div>
                                <div class="order-product-subtotal">Â¥${item.subtotal.toFixed(2)}</div>
                            </div>
                        `).join('')}
                        <div style="text-align:right;padding-top:15px;border-top:1px solid #f0f0f0;margin-top:10px;">
                            <span style="color:#666;">åˆè®¡ï¼š</span>
                            <span style="font-size:20px;font-weight:bold;color:#e4393c;">Â¥${order.total_amount.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <!-- æ”¯ä»˜ä¿¡æ¯ -->
                ${order.payment ? `
                <div class="detail-section">
                    <div class="detail-section-header">ğŸ’³ æ”¯ä»˜ä¿¡æ¯</div>
                    <div class="detail-section-body">
                        <div class="detail-info-grid">
                            <div class="detail-info-item">
                                <div class="label">äº¤æ˜“å·</div>
                                <div class="value">${order.payment.transaction_id}</div>
                            </div>
                            <div class="detail-info-item">
                                <div class="label">æ”¯ä»˜æ–¹å¼</div>
                                <div class="value">${order.payment.payment_method_text || getPayMethodName(order.payment.payment_method)}</div>
                            </div>
                            <div class="detail-info-item">
                                <div class="label">æ”¯ä»˜é‡‘é¢</div>
                                <div class="value" style="color:#e4393c;">Â¥${parseFloat(order.payment.amount).toFixed(2)}</div>
                            </div>
                            <div class="detail-info-item">
                                <div class="label">æ”¯ä»˜æ—¶é—´</div>
                                <div class="value">${order.payment.pay_time || '-'}</div>
                            </div>
                        </div>
                    </div>
                </div>` : ''}
            `;

            // å¦‚æœURLå¸¦pay=1ä¸”è®¢å•å¾…ä»˜æ¬¾ï¼Œè‡ªåŠ¨å¼¹å‡ºæ”¯ä»˜
            const params = new URLSearchParams(window.location.search);
            if (params.get('pay') === '1' && order.status === 0) {
                showPayModal();
            }
        }

        function getStatusGradient(status) {
            const map = {
                0: '#faad14, #ffc53d',
                1: '#1890ff, #40a9ff',
                2: '#722ed1, #9254de',
                3: '#52c41a, #73d13d',
                4: '#8c8c8c, #bfbfbf',
                5: '#ff4d4f, #ff7875'
            };
            return map[status] || '#999, #bbb';
        }

        function getStatusColor(status) {
            const map = { 0: '#faad14', 1: '#1890ff', 2: '#722ed1', 3: '#52c41a', 4: '#999', 5: '#ff4d4f' };
            return map[status] || '#999';
        }

        function getStatusDescription(status) {
            const map = {
                0: 'è¯·å°½å¿«å®Œæˆæ”¯ä»˜ï¼Œè¶…æ—¶è®¢å•å°†è‡ªåŠ¨å–æ¶ˆ',
                1: 'å•†å®¶æ­£åœ¨å‡†å¤‡å‘è´§ï¼Œè¯·è€å¿ƒç­‰å¾…',
                2: 'å•†å“å·²å‘å‡ºï¼Œè¯·æ³¨æ„æŸ¥æ”¶',
                3: 'äº¤æ˜“å·²å®Œæˆï¼Œæ„Ÿè°¢æ‚¨çš„è´­ä¹°',
                4: 'è®¢å•å·²å–æ¶ˆ',
                5: 'é€€æ¬¾å·²å¤„ç†'
            };
            return map[status] || '';
        }

        function getDetailActions(order) {
            let html = '';
            switch (order.status) {
                case 0:
                    html += `<button onclick="showPayModal()" style="padding:10px 30px;background:#fff;color:#e4393c;border:none;border-radius:6px;font-weight:bold;cursor:pointer;">ç«‹å³æ”¯ä»˜</button>`;
                    html += `<button onclick="cancelThisOrder()" style="padding:10px 30px;background:rgba(255,255,255,0.2);color:#fff;border:1px solid rgba(255,255,255,0.5);border-radius:6px;cursor:pointer;">å–æ¶ˆè®¢å•</button>`;
                    break;
                case 2:
                    html += `<button onclick="confirmThisOrder()" style="padding:10px 30px;background:#fff;color:#722ed1;border:none;border-radius:6px;font-weight:bold;cursor:pointer;">ç¡®è®¤æ”¶è´§</button>`;
                    break;
            }
            return html;
        }

        function getPayMethodName(method) {
            const map = { alipay: 'æ”¯ä»˜å®', wechat: 'å¾®ä¿¡æ”¯ä»˜', balance: 'ä½™é¢æ”¯ä»˜' };
            return map[method] || method;
        }

        // æ”¯ä»˜ç›¸å…³
        function showPayModal() {
            if (!orderData || orderData.status !== 0) return;
            document.getElementById('payAmount').textContent = 'Â¥' + orderData.total_amount.toFixed(2);
            document.getElementById('payModal').style.display = 'flex';
        }

        function hidePayModal() {
            document.getElementById('payModal').style.display = 'none';
        }

        function selectPayment(el, method) {
            selectedPayment = method;
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
            el.classList.add('selected');
        }

        async function confirmPay() {
            const result = await OrderAPI.payOrder(orderId, selectedPayment);
            if (result.success) {
                hidePayModal();
                alert('ğŸ‰ æ”¯ä»˜æˆåŠŸï¼');
                loadOrderDetail();
            } else {
                alert('æ”¯ä»˜å¤±è´¥ï¼š' + result.message);
            }
        }

        async function cancelThisOrder() {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆæ­¤è®¢å•å—ï¼Ÿ')) return;
            const result = await OrderAPI.cancelOrder(orderId);
            if (result.success) {
                loadOrderDetail();
            } else {
                alert(result.message);
            }
        }

        async function confirmThisOrder() {
            if (!confirm('ç¡®è®¤å·²æ”¶åˆ°å•†å“ï¼Ÿ')) return;
            const result = await OrderAPI.confirmOrder(orderId);
            if (result.success) {
                loadOrderDetail();
            } else {
                alert(result.message);
            }
        }

        async function handleLogout() {
            await API.logout();
            Auth.clearUser();
            window.location.href = 'index.html';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
