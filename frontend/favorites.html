<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ”¶è— - Shop</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/product.css">
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸ›’ Shop</a>
        <div class="nav-links" id="navLinks"></div>
    </nav>

    <div class="page-container user-page">
        <div class="breadcrumb">
            <a href="index.html">é¦–é¡µ</a> &gt;
            <a href="profile.html">ä¸ªäººä¸­å¿ƒ</a> &gt;
            <span>æˆ‘çš„æ”¶è—</span>
        </div>

        <div class="page-header">
            <h2>â¤ï¸ æˆ‘çš„æ”¶è—</h2>
            <span id="totalCount" style="color:#999;font-size:14px;"></span>
        </div>

        <div id="favContent">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <div class="pagination" id="pagination" style="display:none;"></div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentPage = 1;
        const pageSize = 12;

        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireLogin()) return;
            updateNavbar();
            loadFavorites();
        });

        function updateNavbar() {
            const navLinks = document.getElementById('navLinks');
            const user = Auth.getUser();
            navLinks.innerHTML = `
                <a href="products.html">å•†å“</a>
                <a href="cart.html">ğŸ›’ è´­ç‰©è½¦</a>
                <a href="orders.html">ğŸ“¦ è®¢å•</a>
                <a href="favorites.html">â¤ï¸ æ”¶è—</a>
                <a href="footprints.html">ğŸ‘£ è¶³è¿¹</a>
                <a href="profile.html">ğŸ‘¤ ${user ? user.username : ''}</a>
                <a href="#" onclick="handleLogout()">é€€å‡º</a>
            `;
        }

        async function loadFavorites() {
            const container = document.getElementById('favContent');
            const result = await API.getFavoriteList(currentPage, pageSize);

            if (!result.success) {
                container.innerHTML = `<div class="error-state">${result.message}</div>`;
                return;
            }

            const { list, total, total_pages } = result.data;
            document.getElementById('totalCount').textContent = `å…± ${total} ä»¶æ”¶è—`;

            if (list.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size:48px;margin-bottom:15px;">ğŸ¤</p>
                        <p>è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•å•†å“</p>
                        <a href="products.html" style="color:#007bff;text-decoration:none;margin-top:10px;display:inline-block;">å»é€›é€› â†’</a>
                    </div>`;
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            container.innerHTML = `
                <div class="fav-grid">
                    ${list.map(item => `
                        <div class="fav-card" id="fav-${item.id}">
                            <div class="fav-img" onclick="goProduct(${item.product_id})">
                                ${item.cover_image
                                    ? `<img src="${item.cover_image}" alt="${escapeHtml(item.product_name)}" />`
                                    : '<span style="color:#ccc;">æš‚æ— å›¾ç‰‡</span>'
                                }
                            </div>
                            <div class="fav-info">
                                <div class="fav-name" onclick="goProduct(${item.product_id})">${escapeHtml(item.product_name)}</div>
                                <div class="fav-price">Â¥${parseFloat(item.price).toFixed(2)}</div>
                                <div class="fav-time">æ”¶è—äº ${item.created_at ? item.created_at.substring(0, 10) : ''}</div>
                                <div class="fav-actions">
                                    <button class="btn-sm" onclick="goProduct(${item.product_id})">æŸ¥çœ‹è¯¦æƒ…</button>
                                    <button class="btn-sm btn-remove" onclick="removeFavorite(${item.product_id}, ${item.id})">å–æ¶ˆæ”¶è—</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;

            renderPagination(total_pages);
        }

        async function removeFavorite(productId, favId) {
            if (!confirm('ç¡®å®šå–æ¶ˆæ”¶è—ï¼Ÿ')) return;
            const result = await API.deleteFavorite(productId);
            if (result.success) {
                const card = document.getElementById('fav-' + favId);
                if (card) {
                    card.style.transition = 'opacity 0.3s, transform 0.3s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        card.remove();
                        // å¦‚æœå½“å‰é¡µæ²¡æœ‰å¡ç‰‡äº†ï¼Œé‡æ–°åŠ è½½
                        if (document.querySelectorAll('.fav-card').length === 0) {
                            if (currentPage > 1) currentPage--;
                            loadFavorites();
                        }
                    }, 300);
                }
            } else {
                alert(result.message);
            }
        }

        function goProduct(productId) {
            window.location.href = 'product-detail.html?id=' + productId;
        }

        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            let html = `<span class="page-info">ç¬¬ ${currentPage}/${totalPages} é¡µ</span>`;

            if (currentPage > 1) {
                html += `<button class="page-btn" onclick="goPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            }

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
                } else if (Math.abs(i - currentPage) === 3) {
                    html += '<span class="page-ellipsis">...</span>';
                }
            }

            if (currentPage < totalPages) {
                html += `<button class="page-btn" onclick="goPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            }

            pagination.innerHTML = html;
        }

        function goPage(page) {
            currentPage = page;
            loadFavorites();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function handleLogout() {
            await API.logout();
            Auth.clearUser();
            window.location.href = 'index.html';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
