<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµè§ˆè¶³è¿¹ - Shop</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/product.css">
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">ğŸ›’ Shop</a>
        <div class="nav-links" id="navLinks"></div>
    </nav>

    <div class="page-container user-page">
        <div class="breadcrumb">
            <a href="index.html">é¦–é¡µ</a> &gt;
            <a href="profile.html">ä¸ªäººä¸­å¿ƒ</a> &gt;
            <span>æµè§ˆè¶³è¿¹</span>
        </div>

        <div class="page-header">
            <h2>ğŸ‘£ æµè§ˆè¶³è¿¹</h2>
            <div>
                <span id="totalCount" style="color:#999;font-size:14px;margin-right:15px;"></span>
                <button class="btn-clear" id="btnClear" style="display:none;" onclick="clearAllFootprints()">ğŸ—‘ï¸ æ¸…ç©ºè¶³è¿¹</button>
            </div>
        </div>

        <div id="fpContent">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <div class="pagination" id="pagination" style="display:none;"></div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentPage = 1;
        const pageSize = 20;

        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireLogin()) return;
            updateNavbar();
            loadFootprints();
        });

        function updateNavbar() {
            const navLinks = document.getElementById('navLinks');
            const user = Auth.getUser();
            navLinks.innerHTML = `
                <a href="products.html">å•†å“</a>
                <a href="cart.html">ğŸ›’ è´­ç‰©è½¦</a>
                <a href="orders.html">ğŸ“¦ è®¢å•</a>
                <a href="favorites.html">â¤ï¸ æ”¶è—</a>
                <a href="footprints.html">ğŸ‘£ è¶³è¿¹</a>
                <a href="profile.html">ğŸ‘¤ ${user ? user.username : ''}</a>
                <a href="#" onclick="handleLogout()">é€€å‡º</a>
            `;
        }

        async function loadFootprints() {
            const container = document.getElementById('fpContent');
            const result = await API.getFootprintList(currentPage, pageSize);

            if (!result.success) {
                container.innerHTML = `<div class="error-state">${result.message}</div>`;
                return;
            }

            const { list, total, total_pages } = result.data;
            document.getElementById('totalCount').textContent = `å…± ${total} æ¡è®°å½•`;
            document.getElementById('btnClear').style.display = total > 0 ? 'inline-block' : 'none';

            if (list.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size:48px;margin-bottom:15px;">ğŸ‘£</p>
                        <p>è¿˜æ²¡æœ‰æµè§ˆè®°å½•</p>
                        <a href="products.html" style="color:#007bff;text-decoration:none;margin-top:10px;display:inline-block;">å»é€›é€› â†’</a>
                    </div>`;
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„
            const groups = {};
            list.forEach(item => {
                const date = item.last_visit_at ? item.last_visit_at.substring(0, 10) : 'æœªçŸ¥æ—¥æœŸ';
                if (!groups[date]) groups[date] = [];
                groups[date].push(item);
            });

            let html = '';
            for (const [date, items] of Object.entries(groups)) {
                const label = getDateLabel(date);
                html += `<div class="date-group-title">${label}</div>`;
                html += items.map(item => `
                    <div class="footprint-item" id="fp-${item.id}">
                        <div class="fp-img" onclick="goProduct(${item.product_id})">
                            ${item.cover_image
                                ? `<img src="${item.cover_image}" alt="${escapeHtml(item.product_name)}" />`
                                : '<span style="color:#ccc;font-size:12px;">æ— å›¾</span>'
                            }
                        </div>
                        <div class="fp-info">
                            <div class="fp-name" onclick="goProduct(${item.product_id})">${escapeHtml(item.product_name)}</div>
                            <div class="fp-price">Â¥${parseFloat(item.price).toFixed(2)}</div>
                            <div class="fp-time">æµè§ˆ ${item.visit_count || 1} æ¬¡ Â· ${item.last_visit_at ? item.last_visit_at.substring(11, 16) : ''}</div>
                        </div>
                        <div class="fp-actions">
                            <button class="fp-delete" onclick="deleteFootprint(${item.id})" title="åˆ é™¤">âœ•</button>
                        </div>
                    </div>
                `).join('');
            }

            container.innerHTML = html;
            renderPagination(total_pages);
        }

        function getDateLabel(dateStr) {
            const today = new Date().toISOString().substring(0, 10);
            const yesterday = new Date(Date.now() - 86400000).toISOString().substring(0, 10);
            if (dateStr === today) return 'ğŸ“… ä»Šå¤©';
            if (dateStr === yesterday) return 'ğŸ“… æ˜¨å¤©';
            return 'ğŸ“… ' + dateStr;
        }

        async function deleteFootprint(fpId) {
            const result = await API.deleteFootprint(fpId);
            if (result.success) {
                const el = document.getElementById('fp-' + fpId);
                if (el) {
                    el.style.transition = 'opacity 0.3s, height 0.3s, margin 0.3s, padding 0.3s';
                    el.style.opacity = '0';
                    el.style.height = '0';
                    el.style.margin = '0';
                    el.style.padding = '0';
                    el.style.overflow = 'hidden';
                    setTimeout(() => {
                        el.remove();
                        if (document.querySelectorAll('.footprint-item').length === 0) {
                            if (currentPage > 1) currentPage--;
                            loadFootprints();
                        }
                    }, 300);
                }
            } else {
                alert(result.message);
            }
        }

        async function clearAllFootprints() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æµè§ˆè¶³è¿¹å—ï¼Ÿ')) return;
            const result = await API.clearFootprints();
            if (result.success) {
                currentPage = 1;
                loadFootprints();
            } else {
                alert(result.message);
            }
        }

        function goProduct(productId) {
            window.location.href = 'product-detail.html?id=' + productId;
        }

        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            let html = `<span class="page-info">ç¬¬ ${currentPage}/${totalPages} é¡µ</span>`;

            if (currentPage > 1) {
                html += `<button class="page-btn" onclick="goPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            }

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
                } else if (Math.abs(i - currentPage) === 3) {
                    html += '<span class="page-ellipsis">...</span>';
                }
            }

            if (currentPage < totalPages) {
                html += `<button class="page-btn" onclick="goPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            }

            pagination.innerHTML = html;
        }

        function goPage(page) {
            currentPage = page;
            loadFootprints();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function handleLogout() {
            await API.logout();
            Auth.clearUser();
            window.location.href = 'index.html';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
